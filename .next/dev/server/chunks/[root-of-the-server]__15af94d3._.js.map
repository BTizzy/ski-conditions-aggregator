{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ryanbartell/ski-conditions-aggregator/lib/resorts.ts"],"sourcesContent":["export interface Resort {\n  id: string;\n  name: string;\n  state: string;\n  lat: number;\n  lon: number;\n  // Elevations: optionally provide base and summit elevations. If both present, `elevationFt` will be computed\n  baseElevationFt?: number; // feet at base / lodge\n  summitElevationFt?: number; // feet at summit\n  elevationFt?: number; // computed midpoint between base and summit when both are provided\n  scrapeUrl: string; // Homepage for scraping conditions (legacy)\n  conditionsUrl?: string; // canonical conditions page (optional)\n  logoUrl?: string;\n}\n\nexport const resorts: Resort[] = [\n  // --- Top Priority Resorts ---\n  {\n    id: 'loon-mountain',\n    name: 'Loon Mountain',\n    state: 'NH',\n    lat: 44.0367,\n    lon: -71.6217,\n    scrapeUrl: 'https://www.loonmtn.com/mountain-info/conditions',\n  },\n  {\n    id: 'sunday-river',\n    name: 'Sunday River',\n    state: 'ME',\n    lat: 44.4722,\n    lon: -70.8567,\n    scrapeUrl: 'https://www.sundayriver.com/mountain-info/conditions',\n  },\n  {\n    id: 'sugarloaf',\n    name: 'Sugarloaf',\n    state: 'ME',\n    lat: 45.0311,\n    lon: -70.3133,\n    scrapeUrl: 'https://www.sugarloaf.com/conditions',\n  },\n  // --- Major Vermont Resorts ---\n  {\n    id: 'stowe',\n    name: 'Stowe',\n    state: 'VT',\n    lat: 44.4654,\n    lon: -72.6874,\n    scrapeUrl: 'https://www.stowe.com/the-mountain/mountain-conditions/',\n  },\n  {\n    id: 'killington',\n    name: 'Killington',\n    state: 'VT',\n    lat: 43.6045,\n    lon: -72.8201,\n    scrapeUrl: 'https://www.killington.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'sugarbush',\n    name: 'Sugarbush',\n    state: 'VT',\n    lat: 44.1436,\n    lon: -72.8944,\n    scrapeUrl: 'https://www.sugarbush.com/mountain-info/conditions/',\n  },\n  {\n    id: 'okemo',\n    name: 'Okemo',\n    state: 'VT',\n    lat: 43.4036,\n    lon: -72.7202,\n    scrapeUrl: 'https://www.okemo.com/the-mountain/mountain-conditions/',\n  },\n  {\n    id: 'mount-snow',\n    name: 'Mount Snow',\n    state: 'VT',\n    lat: 42.9606,\n    lon: -72.9205,\n    scrapeUrl: 'https://www.mountsnow.com/the-mountain/mountain-conditions/',\n  },\n  {\n    id: 'stratton',\n    name: 'Stratton',\n    state: 'VT',\n    lat: 43.1135,\n    lon: -72.9205,\n    scrapeUrl: 'https://www.stratton.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'jay-peak',\n    name: 'Jay Peak',\n    state: 'VT',\n    lat: 44.9242,\n    lon: -72.5316,\n    scrapeUrl: 'https://jaypeakresort.com/ski-ride/conditions',\n  },\n  {\n    id: 'smugglers-notch',\n    name: \"Smugglers' Notch\",\n    state: 'VT',\n    lat: 44.5884,\n    lon: -72.7815,\n    scrapeUrl: 'https://www.smuggs.com/pages/winter/skiride/conditions.php',\n  },\n  {\n    id: 'bromley',\n    name: 'Bromley',\n    state: 'VT',\n    lat: 43.2137,\n    lon: -72.9362,\n    scrapeUrl: 'https://www.bromley.com/the-mountain/conditions/',\n  },\n  {\n    id: 'mad-river-glen',\n    name: 'Mad River Glen',\n    state: 'VT',\n    lat: 44.2019,\n    lon: -72.9172,\n    scrapeUrl: 'https://www.madriverglen.com/mountain-info/conditions',\n  },\n  // --- Major New Hampshire Resorts ---\n  {\n    id: 'bretton-woods',\n    name: 'Bretton Woods',\n    state: 'NH',\n    lat: 44.2547,\n    lon: -71.4417,\n    scrapeUrl: 'https://www.brettonwoods.com/mountain-info/conditions',\n  },\n  {\n    id: 'cannon-mountain',\n    name: 'Cannon Mountain',\n    state: 'NH',\n    lat: 44.1786,\n    lon: -71.6981,\n    scrapeUrl: 'https://www.cannonmt.com/mountain-info/conditions',\n  },\n  {\n    id: 'waterville-valley',\n    name: 'Waterville Valley',\n    state: 'NH',\n    lat: 43.9506,\n    lon: -71.5072,\n    scrapeUrl: 'https://www.waterville.com/mountain-report',\n  },\n  {\n    id: 'wildcat',\n    name: 'Wildcat',\n    state: 'NH',\n    lat: 44.2581,\n    lon: -71.2256,\n    scrapeUrl: 'https://www.skiwildcat.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'attitash',\n    name: 'Attitash',\n    state: 'NH',\n    lat: 44.0822,\n    lon: -71.2292,\n    scrapeUrl: 'https://www.attitash.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'cranmore',\n    name: 'Cranmore',\n    state: 'NH',\n    lat: 44.0584,\n    lon: -71.1284,\n    scrapeUrl: 'https://www.cranmore.com/conditions',\n  },\n  // --- Southern New Hampshire additions ---\n  {\n    id: 'pats-peak',\n    name: \"Pats Peak\",\n    state: 'NH',\n    lat: 43.0740,\n    lon: -71.7508,\n    // approximate base and summit elevations (ft). These are best-effort values and can be updated later.\n    baseElevationFt: 620,\n    summitElevationFt: 1030,\n    scrapeUrl: 'https://www.patspeak.com',\n    conditionsUrl: 'https://www.patspeak.com/conditions',\n  },\n  {\n    id: 'mount-sunapee',\n    name: 'Mount Sunapee',\n    state: 'NH',\n    lat: 43.3337,\n    lon: -72.0586,\n    baseElevationFt: 1600,\n    summitElevationFt: 2743,\n    scrapeUrl: 'https://www.mountsunapee.com',\n    conditionsUrl: 'https://www.mountsunapee.com/mountain/conditions',\n  },\n  {\n    id: 'gunstock',\n    name: 'Gunstock',\n    state: 'NH',\n    lat: 43.5792,\n    lon: -71.4246,\n    baseElevationFt: 600,\n    summitElevationFt: 2240,\n    scrapeUrl: 'https://www.gunstock.com',\n    conditionsUrl: 'https://www.gunstock.com/mountain-report',\n  },\n  {\n    id: 'crotched-mountain',\n    name: 'Crotched Mountain',\n    state: 'NH',\n    lat: 42.8537,\n    lon: -71.6146,\n    baseElevationFt: 400,\n    summitElevationFt: 2066,\n    scrapeUrl: 'https://www.crotchedmountain.org',\n    conditionsUrl: 'https://www.crotchedmountain.org/mountain-report',\n  },\n  {\n    id: 'mcintyre',\n    name: 'McIntyre Ski Area',\n    state: 'NH',\n    lat: 42.9955,\n    lon: -71.4601,\n    baseElevationFt: 200,\n    summitElevationFt: 350,\n    scrapeUrl: 'https://www.mcintyreskiarea.com',\n    conditionsUrl: 'https://www.mcintyreskiarea.com/conditions',\n  },\n  {\n    id: 'ragged-mountain',\n    name: 'Ragged Mountain',\n    state: 'NH',\n    lat: 43.2986,\n    lon: -71.8514,\n    baseElevationFt: 600,\n    summitElevationFt: 1350,\n    scrapeUrl: 'https://skiragged.com',\n    conditionsUrl: 'https://skiragged.com/mountain-report',\n  },\n  // --- Additional Maine Resorts ---\n  {\n    id: 'saddleback',\n    name: 'Saddleback',\n    state: 'ME',\n    lat: 44.9531,\n    lon: -70.5272,\n    scrapeUrl: 'https://www.saddlebackmaine.com/conditions/',\n  },\n  {\n    id: 'squaw-mountain',\n    name: 'Squaw Mountain',\n    state: 'ME',\n    lat: 44.0822,\n    lon: -70.7567,\n    scrapeUrl: 'https://www.squawmt.com/conditions/',\n  },\n  // --- Massachusetts Resorts ---\n  {\n    id: 'jiminy-peak',\n    name: 'Jiminy Peak',\n    state: 'MA',\n    lat: 42.5556,\n    lon: -73.2922,\n    scrapeUrl: 'https://www.jiminypeak.com/mountain/conditions',\n  },\n  {\n    id: 'wachusett',\n    name: 'Wachusett',\n    state: 'MA',\n    lat: 42.5031,\n    lon: -71.8867,\n    scrapeUrl: 'https://www.wachusett.com/The-Mountain/Conditions.aspx',\n  },\n  // --- New York Resorts ---\n  {\n    id: 'whiteface',\n    name: 'Whiteface',\n    state: 'NY',\n    lat: 44.3656,\n    lon: -73.9022,\n    scrapeUrl: 'https://whiteface.com/conditions',\n  },\n  {\n    id: 'gore-mountain',\n    name: 'Gore Mountain',\n    state: 'NY',\n    lat: 43.6747,\n    lon: -74.0061,\n    scrapeUrl: 'https://goremountain.com/conditions/',\n  },\n  {\n    id: 'hunter-mountain',\n    name: 'Hunter Mountain',\n    state: 'NY',\n    lat: 42.2022,\n    lon: -74.2331,\n    scrapeUrl: 'https://www.huntermtn.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'windham-mountain',\n    name: 'Windham Mountain',\n    state: 'NY',\n    lat: 42.2917,\n    lon: -74.2581,\n    scrapeUrl: 'https://www.windhammountain.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'belleayre',\n    name: 'Belleayre',\n    state: 'NY',\n    lat: 42.1356,\n    lon: -74.5061,\n    scrapeUrl: 'https://www.belleayre.com/conditions/',\n  },\n  // --- Pennsylvania Resorts ---\n  {\n    id: 'jack-frost-big-boulder',\n    name: 'Jack Frost Big Boulder',\n    state: 'PA',\n    lat: 41.1081,\n    lon: -75.6581,\n    scrapeUrl: 'https://www.jfbb.com/conditions/',\n  },\n  {\n    id: 'elk-mountain',\n    name: 'Elk Mountain',\n    state: 'PA',\n    lat: 41.7131,\n    lon: -75.5781,\n    scrapeUrl: 'https://www.elkskier.com/conditions/',\n  },\n  {\n    id: 'blue-mountain',\n    name: 'Blue Mountain',\n    state: 'PA',\n    lat: 40.8117,\n    lon: -75.5217,\n    scrapeUrl: 'https://www.skibluemt.com/mountain-report/',\n  },\n  {\n    id: 'seven-springs',\n    name: 'Seven Springs',\n    state: 'PA',\n    lat: 40.0231,\n    lon: -79.2981,\n    scrapeUrl: 'https://www.7springs.com/conditions/',\n  },\n  // --- Connecticut Resorts ---\n  {\n    id: 'mount-southington',\n    name: 'Mount Southington',\n    state: 'CT',\n    lat: 41.5992,\n    lon: -72.9272,\n    scrapeUrl: 'https://mountsouthington.com/conditions/',\n  },\n  {\n    id: 'powder-ridge',\n    name: 'Powder Ridge',\n    state: 'CT',\n    lat: 41.4992,\n    lon: -72.8272,\n    scrapeUrl: 'https://www.powderridgepark.com/conditions/',\n  },\n  // --- New Jersey Resorts ---\n  {\n    id: 'mountain-creek',\n    name: 'Mountain Creek',\n    state: 'NJ',\n    lat: 41.1822,\n    lon: -74.5081,\n    scrapeUrl: 'https://www.mountaincreek.com/mountain/conditions/',\n  },\n  {\n    id: 'campgaw-mountain',\n    name: 'Campgaw Mountain',\n    state: 'NJ',\n    lat: 41.0481,\n    lon: -74.2081,\n    scrapeUrl: 'https://www.campgaw.com/conditions/',\n  },\n  // --- Additional New Hampshire Resorts ---\n  {\n    id: 'black-mountain',\n    name: 'Black Mountain',\n    state: 'NH',\n    lat: 44.1667,\n    lon: -71.1667,\n    scrapeUrl: 'https://www.blackmt.com/conditions/',\n  },\n];\n\n// Post-process to compute elevationFt for entries that provide base+summit\nfor (const r of resorts) {\n  if (r.baseElevationFt !== undefined && r.summitElevationFt !== undefined && (r.elevationFt === undefined || r.elevationFt === null)) {\n    // midpoint elevation (average) between base lodge and summit\n    r.elevationFt = Math.round(((r.baseElevationFt + r.summitElevationFt) / 2) * 10) / 10;\n  }\n\n  // Keep object shape consistent: ensure elevationFt is number or undefined\n  if (r.elevationFt === undefined) delete r.elevationFt;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 439, "column": 0}, "map": {"version":3,"sources":["file:///Users/ryanbartell/ski-conditions-aggregator/lib/nws.ts"],"sourcesContent":["\nexport interface NWSObservation {\n  temperature: number | null; // Celsius\n  windSpeed: number | null; // km/h\n  windDirection: number | null; // degrees\n  textDescription: string;\n  icon: string;\n  timestamp: string;\n  raw: any;\n}\n\n// Get NWS gridpoint for a given lat/lon\nexport async function getNWSGridpoint(lat: number, lon: number): Promise<{office: string, gridX: number, gridY: number}> {\n  const url = `https://api.weather.gov/points/${lat},${lon}`;\n  const res = await fetch(url, { headers: { 'User-Agent': 'ski-conditions-aggregator' } });\n  if (!res.ok) throw new Error('Failed to get NWS gridpoint');\n  const data = await res.json();\n  return {\n    office: data.properties.gridId,\n    gridX: data.properties.gridX,\n    gridY: data.properties.gridY,\n  };\n}\n\n// Get current observation for a gridpoint\nexport async function getNWSObservation(lat: number, lon: number): Promise<NWSObservation> {\n  const grid = await getNWSGridpoint(lat, lon);\n  const url = `https://api.weather.gov/gridpoints/${grid.office}/${grid.gridX},${grid.gridY}/forecast`;\n  const res = await fetch(url, { headers: { 'User-Agent': 'ski-conditions-aggregator' } });\n  if (!res.ok) throw new Error('Failed to get NWS forecast');\n  const data = await res.json();\n  const period = data.properties.periods[0];\n  return {\n    temperature: period.temperature,\n    windSpeed: period.windSpeed ? parseInt(period.windSpeed) : null,\n    windDirection: period.windDirection || null,\n    textDescription: period.shortForecast,\n    icon: period.icon,\n    timestamp: period.startTime,\n    raw: period,\n  };\n}\n\n// Find nearest observation station and return its id and distance (km)\nexport async function getNearestNWSStation(lat: number, lon: number): Promise<{stationId: string|null, distanceKm: number|null}> {\n  try {\n    const pointUrl = `https://api.weather.gov/points/${lat},${lon}`;\n    const pRes = await fetch(pointUrl, { headers: { 'User-Agent': 'ski-conditions-aggregator' } });\n    if (!pRes.ok) return { stationId: null, distanceKm: null };\n    const pData = await pRes.json();\n    const stationsUrl = pData.properties.observationStations;\n    if (!stationsUrl) return { stationId: null, distanceKm: null };\n    const sRes = await fetch(stationsUrl, { headers: { 'User-Agent': 'ski-conditions-aggregator' } });\n    if (!sRes.ok) return { stationId: null, distanceKm: null };\n    const sData = await sRes.json();\n    const stations = sData.features || sData;\n    if (!stations || stations.length === 0) return { stationId: null, distanceKm: null };\n    // pick first station and compute distance if coordinates available\n    const first = stations[0];\n    const coords = (first && first.geometry && first.geometry.coordinates) ? first.geometry.coordinates : null;\n    if (!coords) return { stationId: first.properties?.stationIdentifier ?? null, distanceKm: null };\n    const [stLon, stLat] = coords;\n    const distanceKm = haversineKm(lat, lon, stLat, stLon);\n    return { stationId: first.properties?.stationIdentifier ?? null, distanceKm };\n  } catch (e) {\n    return { stationId: null, distanceKm: null };\n  }\n}\n\n// Fetch hourly observations for a station between start and end ISO times. Returns array of observation objects.\nexport async function fetchStationObservations(stationId: string, startISO: string, endISO: string): Promise<any[]> {\n  try {\n    // NWS API enforces a maximum \"limit\" (500). Use 500 to avoid 400 Bad Request responses.\n    const url = `https://api.weather.gov/stations/${stationId}/observations?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&limit=500`;\n    const res = await fetch(url, { headers: { 'User-Agent': 'ski-conditions-aggregator' } });\n    if (!res.ok) return [];\n    const data = await res.json();\n    return data.features || [];\n  } catch (e) {\n    return [];\n  }\n}\n\n// Convenience: get historical observations near lat/lon for the last `days` days.\nexport async function getHistoricalObservations(lat: number, lon: number, days = 7): Promise<{observations: Array<any>, stationId: string|null, stationDistanceKm: number|null}> {\n  try {\n    const { stationId, distanceKm } = await getNearestNWSStation(lat, lon);\n    if (!stationId) return { observations: [], stationId: null, stationDistanceKm: null };\n    const end = new Date();\n    const start = new Date(end.getTime() - days * 24 * 3600 * 1000);\n    const startISO = start.toISOString();\n    const endISO = end.toISOString();\n    const obs = await fetchStationObservations(stationId, startISO, endISO);\n    return { observations: obs, stationId, stationDistanceKm: distanceKm };\n  } catch (e) {\n    return { observations: [], stationId: null, stationDistanceKm: null };\n  }\n}\n\nfunction haversineKm(lat1: number, lon1: number, lat2: number, lon2: number) {\n  const R = 6371; // km\n  const toRad = (v: number) => v * Math.PI / 180;\n  const dLat = toRad(lat2 - lat1);\n  const dLon = toRad(lon2 - lon1);\n  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n  return R * c;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAYO,eAAe,gBAAgB,GAAW,EAAE,GAAW;IAC5D,MAAM,MAAM,CAAC,+BAA+B,EAAE,IAAI,CAAC,EAAE,KAAK;IAC1D,MAAM,MAAM,MAAM,MAAM,KAAK;QAAE,SAAS;YAAE,cAAc;QAA4B;IAAE;IACtF,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM;IAC7B,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,OAAO;QACL,QAAQ,KAAK,UAAU,CAAC,MAAM;QAC9B,OAAO,KAAK,UAAU,CAAC,KAAK;QAC5B,OAAO,KAAK,UAAU,CAAC,KAAK;IAC9B;AACF;AAGO,eAAe,kBAAkB,GAAW,EAAE,GAAW;IAC9D,MAAM,OAAO,MAAM,gBAAgB,KAAK;IACxC,MAAM,MAAM,CAAC,mCAAmC,EAAE,KAAK,MAAM,CAAC,CAAC,EAAE,KAAK,KAAK,CAAC,CAAC,EAAE,KAAK,KAAK,CAAC,SAAS,CAAC;IACpG,MAAM,MAAM,MAAM,MAAM,KAAK;QAAE,SAAS;YAAE,cAAc;QAA4B;IAAE;IACtF,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM;IAC7B,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,MAAM,SAAS,KAAK,UAAU,CAAC,OAAO,CAAC,EAAE;IACzC,OAAO;QACL,aAAa,OAAO,WAAW;QAC/B,WAAW,OAAO,SAAS,GAAG,SAAS,OAAO,SAAS,IAAI;QAC3D,eAAe,OAAO,aAAa,IAAI;QACvC,iBAAiB,OAAO,aAAa;QACrC,MAAM,OAAO,IAAI;QACjB,WAAW,OAAO,SAAS;QAC3B,KAAK;IACP;AACF;AAGO,eAAe,qBAAqB,GAAW,EAAE,GAAW;IACjE,IAAI;QACF,MAAM,WAAW,CAAC,+BAA+B,EAAE,IAAI,CAAC,EAAE,KAAK;QAC/D,MAAM,OAAO,MAAM,MAAM,UAAU;YAAE,SAAS;gBAAE,cAAc;YAA4B;QAAE;QAC5F,IAAI,CAAC,KAAK,EAAE,EAAE,OAAO;YAAE,WAAW;YAAM,YAAY;QAAK;QACzD,MAAM,QAAQ,MAAM,KAAK,IAAI;QAC7B,MAAM,cAAc,MAAM,UAAU,CAAC,mBAAmB;QACxD,IAAI,CAAC,aAAa,OAAO;YAAE,WAAW;YAAM,YAAY;QAAK;QAC7D,MAAM,OAAO,MAAM,MAAM,aAAa;YAAE,SAAS;gBAAE,cAAc;YAA4B;QAAE;QAC/F,IAAI,CAAC,KAAK,EAAE,EAAE,OAAO;YAAE,WAAW;YAAM,YAAY;QAAK;QACzD,MAAM,QAAQ,MAAM,KAAK,IAAI;QAC7B,MAAM,WAAW,MAAM,QAAQ,IAAI;QACnC,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG,OAAO;YAAE,WAAW;YAAM,YAAY;QAAK;QACnF,mEAAmE;QACnE,MAAM,QAAQ,QAAQ,CAAC,EAAE;QACzB,MAAM,SAAS,AAAC,SAAS,MAAM,QAAQ,IAAI,MAAM,QAAQ,CAAC,WAAW,GAAI,MAAM,QAAQ,CAAC,WAAW,GAAG;QACtG,IAAI,CAAC,QAAQ,OAAO;YAAE,WAAW,MAAM,UAAU,EAAE,qBAAqB;YAAM,YAAY;QAAK;QAC/F,MAAM,CAAC,OAAO,MAAM,GAAG;QACvB,MAAM,aAAa,YAAY,KAAK,KAAK,OAAO;QAChD,OAAO;YAAE,WAAW,MAAM,UAAU,EAAE,qBAAqB;YAAM;QAAW;IAC9E,EAAE,OAAO,GAAG;QACV,OAAO;YAAE,WAAW;YAAM,YAAY;QAAK;IAC7C;AACF;AAGO,eAAe,yBAAyB,SAAiB,EAAE,QAAgB,EAAE,MAAc;IAChG,IAAI;QACF,wFAAwF;QACxF,MAAM,MAAM,CAAC,iCAAiC,EAAE,UAAU,oBAAoB,EAAE,mBAAmB,UAAU,KAAK,EAAE,mBAAmB,QAAQ,UAAU,CAAC;QAC1J,MAAM,MAAM,MAAM,MAAM,KAAK;YAAE,SAAS;gBAAE,cAAc;YAA4B;QAAE;QACtF,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO,EAAE;QACtB,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,OAAO,KAAK,QAAQ,IAAI,EAAE;IAC5B,EAAE,OAAO,GAAG;QACV,OAAO,EAAE;IACX;AACF;AAGO,eAAe,0BAA0B,GAAW,EAAE,GAAW,EAAE,OAAO,CAAC;IAChF,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,MAAM,qBAAqB,KAAK;QAClE,IAAI,CAAC,WAAW,OAAO;YAAE,cAAc,EAAE;YAAE,WAAW;YAAM,mBAAmB;QAAK;QACpF,MAAM,MAAM,IAAI;QAChB,MAAM,QAAQ,IAAI,KAAK,IAAI,OAAO,KAAK,OAAO,KAAK,OAAO;QAC1D,MAAM,WAAW,MAAM,WAAW;QAClC,MAAM,SAAS,IAAI,WAAW;QAC9B,MAAM,MAAM,MAAM,yBAAyB,WAAW,UAAU;QAChE,OAAO;YAAE,cAAc;YAAK;YAAW,mBAAmB;QAAW;IACvE,EAAE,OAAO,GAAG;QACV,OAAO;YAAE,cAAc,EAAE;YAAE,WAAW;YAAM,mBAAmB;QAAK;IACtE;AACF;AAEA,SAAS,YAAY,IAAY,EAAE,IAAY,EAAE,IAAY,EAAE,IAAY;IACzE,MAAM,IAAI,MAAM,KAAK;IACrB,MAAM,QAAQ,CAAC,IAAc,IAAI,KAAK,EAAE,GAAG;IAC3C,MAAM,OAAO,MAAM,OAAO;IAC1B,MAAM,OAAO,MAAM,OAAO;IAC1B,MAAM,IAAI,KAAK,GAAG,CAAC,OAAK,KAAK,KAAK,GAAG,CAAC,OAAK,KAAK,KAAK,GAAG,CAAC,MAAM,SAAS,KAAK,GAAG,CAAC,MAAM,SAAS,KAAK,GAAG,CAAC,OAAK,KAAK,KAAK,GAAG,CAAC,OAAK;IACjI,MAAM,IAAI,IAAI,KAAK,KAAK,CAAC,KAAK,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,IAAE;IACnD,OAAO,IAAI;AACb"}},
    {"offset": {"line": 595, "column": 0}, "map": {"version":3,"sources":["file:///Users/ryanbartell/ski-conditions-aggregator/lib/snowModel.ts"],"sourcesContent":["import { NWSObservation } from './nws';\nimport { ObservationLike } from './types';\n\n/**\n * Lightweight snowfall/conditions model.\n * - Designed to run deterministically on NWS observations (and optional historical/aux inputs)\n * - Returns estimated recentSnowfall (last 24h), snowDepth (approx), baseTemp (F), windSpeed (mph), visibility (text), and a powder score 0-100.\n *\n * This is intentionally simple and easy to test against historical data. Improve as needed.\n */\n\nfunction cToF(c: number | null | undefined): number | null {\n  if (c === null || c === undefined) return null;\n  return c * 9 / 5 + 32;\n}\n\nfunction kphToMph(kph: number | null | undefined): number | null {\n  if (kph === null || kph === undefined) return null;\n  return kph * 0.621371;\n}\n\nexport interface SnowPrediction {\n  recentSnowfall: number; // inches (last 24h)\n  snowDepth: number; // inches (estimate) - current depth on the ground\n  weeklySnowfall?: number; // inches accumulated over last 7 days\n  // weeklySnowIn: estimated snowfall in inches (converted from liquid via ratio)\n  weeklySnowIn?: number;\n  // weeklyRainIn: estimated liquid inches that fell as rain over last 7 days\n  weeklyRainIn?: number;\n  expectedOnGround?: number; // estimated inches on-ground after melt/compaction\n  baseTemp: number | null; // Fahrenheit\n  windSpeed: number | null; // mph\n  visibility: string;\n  powderScore: number; // 0-100\n  factors: string[];\n}\n\n  // Improved deterministic snow model that consumes NWS observation payloads.\n  // The model prefers numeric precipitation fields and probabilityOfPrecipitation when available\n  // to avoid gross overestimation (Stowe case). Returns a consistent SnowPrediction object.\n  export function predictFromNWS(nws: NWSObservation | null, extra?: ObservationLike): SnowPrediction {\n    const result: any = {\n      recentSnowfall: 0, // inches over recent window (e.g., last 24h)\n      snowDepth: 0, // current depth estimate (inches)\n      baseTemp: NaN, // Fahrenheit\n      windSpeed: 0, // mph\n      visibility: 'Unknown',\n      powderScore: 50,\n      factors: [] as string[],\n    };\n\n    if (!nws) return result;\n\n    // Temperature handling: some NWS payloads have temperature in Fahrenheit (forecast periods)\n    // while others use Celsius. Prefer raw.unit info when available.\n    let tempC: number | null = null;\n    if (typeof nws.temperature === 'number') {\n      const unit = nws?.raw?.temperatureUnit || nws?.raw?.temperature?.unitCode || null;\n      if (unit && String(unit).toUpperCase().startsWith('F')) {\n        // temperature provided as Fahrenheit\n        tempC = (nws.temperature - 32) * 5 / 9;\n      } else {\n        // assume provided in Celsius\n        tempC = nws.temperature;\n      }\n    } else if (nws?.raw?.temperature?.value != null) {\n      tempC = nws.raw.temperature.value;\n    }\n    if (tempC != null && !Number.isNaN(tempC)) result.baseTemp = +(tempC * 9 / 5 + 32).toFixed(1);\n\n    // Wind speed: if nws.windSpeed is a number, the existing project tends to store mph already.\n    if (typeof nws.windSpeed === 'number') {\n      result.windSpeed = nws.windSpeed;\n    } else if (nws?.raw?.windSpeed?.value != null) {\n      // assume raw.windSpeed.value is m/s -> convert to mph\n      const windMs = nws.raw.windSpeed.value;\n      if (!Number.isNaN(windMs)) result.windSpeed = +(windMs * 2.23694).toFixed(2);\n    }\n\n    result.visibility = nws?.textDescription ?? result.visibility;\n\n    // Use reported precipitation fields when available.\n    // Many NWS observation payloads include 'precipitationLastHour' or in properties with unitCode/value.\n    let precipIn = null as null | number; // inches in last window\n    // try a few known fields (value might be mm or in depending on the source) — prefer explicit inches\n    if (nws?.raw?.precipitationLastHour?.value != null) {\n      const mm = nws.raw.precipitationLastHour.value;\n      if (!Number.isNaN(mm)) precipIn = +(mm / 25.4);\n    }\n    // check raw precipitation container\n    if (precipIn == null && nws?.raw?.precipitation?.value != null) {\n      const v = nws.raw.precipitation.value;\n      const unit = nws.raw.precipitation?.unitCode || '';\n      if (typeof v === 'number') {\n        if (unit.toLowerCase().includes('mm')) precipIn = +(v / 25.4);\n        else precipIn = +v;\n      }\n    }\n\n    // probabilityOfPrecipitation is often provided as a percent (0-100) inside raw fields\n  const pop = (nws?.raw?.probabilityOfPrecipitation?.value ?? nws?.raw?.probabilityOfPrecipitation) ?? null;\n\n    // Parse the text description for keywords (snow vs rain) as a tie-breaker\n    const desc = (nws?.textDescription || '').toLowerCase();\n    const mentionsSnow = desc.includes('snow') || desc.includes('flurr');\n    const mentionsSleet = desc.includes('sleet') || desc.includes('mixed');\n\n    // Determine a snowfall fraction: if temps are cold (< 34F) and mention snow, assume precip -> snow\n    let snowFraction = 0.0;\n    if (precipIn != null) {\n      // If we have a measured precipitation amount, use temperature to estimate what portion was snow\n      if (!Number.isNaN(result.baseTemp)) {\n        if (result.baseTemp <= 28) snowFraction = 1.0;\n        else if (result.baseTemp <= 32) snowFraction = 0.9;\n        else if (result.baseTemp <= 36) snowFraction = 0.6;\n        else snowFraction = 0.05; // mostly rain\n      } else {\n        // no temp, rely on text\n        snowFraction = mentionsSnow ? 0.9 : (mentionsSleet ? 0.6 : 0.2);\n      }\n    } else {\n      // no measured precip — fall back to probability and text\n      const p = (typeof pop === 'number' && !Number.isNaN(pop)) ? pop / 100 : 0;\n      if (p > 0) {\n        // if we only have a probability, set expected precip to a conservative value based on probability\n        // assume up to 0.5 inches liquid at very high probabilities (p~1) for short windows\n        const expectedLiquid = Math.min(0.5, 0.5 * p);\n        if (!Number.isNaN(result.baseTemp)) {\n          if (result.baseTemp <= 28) snowFraction = 1.0;\n          else if (result.baseTemp <= 32) snowFraction = 0.95;\n          else if (result.baseTemp <= 36) snowFraction = 0.6;\n          else snowFraction = 0.1;\n        } else {\n          snowFraction = mentionsSnow ? 0.9 : (mentionsSleet ? 0.6 : 0.2);\n        }\n        precipIn = expectedLiquid; // inches of liquid\n      } else {\n        snowFraction = mentionsSnow ? 0.8 : 0.0;\n      }\n    }\n\n    // Convert liquid precipitation to snow inches using rough ratio depending on temp\n    let liquidToSnowRatio = 10; // default 10:1\n    if (!Number.isNaN(result.baseTemp)) {\n      const tempCFromF = (result.baseTemp - 32) * 5 / 9;\n      if (tempCFromF <= -10) liquidToSnowRatio = 18;\n      else if (tempCFromF <= -2) liquidToSnowRatio = 14;\n      else if (tempCFromF <= 0) liquidToSnowRatio = 12;\n      else if (tempCFromF <= 3) liquidToSnowRatio = 10;\n      else liquidToSnowRatio = 8; // wetter snow\n    }\n\n    // expected snow inches from measured precip\n    let expectedSnowIn = 0;\n    if (precipIn != null) {\n      expectedSnowIn = precipIn * liquidToSnowRatio * snowFraction;\n      // dampen for small liquid amounts\n      if (precipIn > 0 && precipIn < 0.5) expectedSnowIn *= 0.6;\n    } else {\n      expectedSnowIn = (precipIn || 0) * liquidToSnowRatio * snowFraction;\n    }\n\n    // final smoothing: be conservative — round to nearest 0.5 inch\n    const recent = Math.max(0, Math.round(expectedSnowIn * 2) / 2);\n    result.recentSnowfall = recent;\n\n    // snowDepth: if observation provides a depth field, prefer it. Try common fields: snowDepth, snowDepthLast24Hours\n    const obsDepth = (nws?.raw?.snowDepth?.value ?? nws?.raw?.snowDepth ?? nws?.raw?.snowFallLast24Hours?.value) ?? null;\n    if (obsDepth != null && !Number.isNaN(obsDepth)) {\n      // If unit is mm convert, otherwise assume inches\n      if (typeof obsDepth === 'number') {\n        // heuristic: if value > 30, assume mm; convert mm -> inches\n        if (obsDepth > 30) result.snowDepth = +(obsDepth / 25.4).toFixed(1);\n        else result.snowDepth = +obsDepth.toFixed(1);\n      }\n    } else {\n      // guess: previous depth plus recent snowfall (conservative)\n      // if extra?.previousDepth provided use it\n      const prev = (extra && typeof extra.previousDepth === 'number') ? extra.previousDepth : 0;\n      result.snowDepth = +(Math.max(prev, prev + result.recentSnowfall)).toFixed(1);\n    }\n\n    // powderScore: prefer conservative base; high score for fresh, cold, low wind\n    let score = 50;\n    score += Math.round((result.recentSnowfall - 2) * 4); // reward recent >2\"\n    if (!Number.isNaN(result.baseTemp) && result.baseTemp <= 20) score += 10;\n    if (result.windSpeed > 25) score -= 20;\n    if (result.recentSnowfall >= 8) score += 8;\n    result.powderScore = Math.min(100, Math.max(0, score));\n\n    // factors\n    if (result.recentSnowfall >= 6) result.factors.push('recent-heavy');\n    else if (result.recentSnowfall >= 2) result.factors.push('recent-light');\n    if (!Number.isNaN(result.baseTemp) && result.baseTemp >= 36) result.factors.push('warm');\n    if (result.windSpeed > 25) result.factors.push('windy');\n\n    // compute weekly snowfall estimate\n  let weekly = 0;\n  let weeklySnowIn = 0; // snow inches (converted) aggregated\n  let weeklyRainIn = 0; // liquid rain inches aggregated\n    // Prefer detailed weeklyObservations if available (array of precip+temp samples)\n    if (extra && Array.isArray(extra.weeklyObservations) && extra.weeklyObservations.length > 0) {\n      let sumSnow = 0;\n      for (const o of extra.weeklyObservations) {\n        const pMm = (o && typeof o.precipMm === 'number') ? o.precipMm : 0;\n        const tC = (o && typeof o.tempC === 'number') ? o.tempC : (extra.avgTemp7d ?? null);\n        const precipIn = pMm / 25.4;\n        // simple temp-based snow fraction per observation\n        let sf = 0.0;\n        if (tC != null) {\n          if (tC <= -10) sf = 1.0;\n          else if (tC <= 0) sf = 0.95;\n          else if (tC <= 3) sf = 0.9;\n          else sf = 0.1;\n        } else {\n          sf = mentionsSnow ? 0.8 : 0.2;\n        }\n        // choose ratio by temp\n        let ratioLocal = liquidToSnowRatio;\n        if (tC != null) {\n          if (tC <= -10) ratioLocal = 18;\n          else if (tC <= -2) ratioLocal = 14;\n          else if (tC <= 0) ratioLocal = 12;\n          else if (tC <= 3) ratioLocal = 10;\n          else ratioLocal = 8;\n        }\n        let snowIn = precipIn * ratioLocal * sf;\n        if (precipIn > 0 && precipIn < 0.5) snowIn *= 0.6;\n        sumSnow += snowIn;\n        // rain liquid inches that fell (liquid portion not snow)\n        const rainLiquid = precipIn * (1 - sf);\n        weeklyRainIn += rainLiquid;\n        weeklySnowIn += snowIn;\n      }\n      weekly = Math.round(sumSnow * 2) / 2;\n    } else if (extra && typeof extra.weeklyPrecipMm === 'number' && extra.weeklyPrecipMm !== null) {\n      const inches = extra.weeklyPrecipMm / 25.4;\n      // approximate splitting of weekly total into snow vs rain using avgTemp7d and snowFraction\n      const avgSf = (!Number.isNaN(result.baseTemp) ? (result.baseTemp <= 32 ? 0.9 : 0.1) : (snowFraction || 0.5));\n      weeklySnowIn = Math.round((inches * liquidToSnowRatio * avgSf) * 2) / 2;\n      weeklyRainIn = Math.round((inches * (1 - avgSf)) * 100) / 100;\n      weekly = weeklySnowIn;\n    } else if (extra && typeof extra.previousWeekSnowfall === 'number' && extra.previousWeekSnowfall !== null) {\n      weekly = extra.previousWeekSnowfall;\n    } else {\n      // fallback: scale recent event conservatively (avoid recent*3 naive approach)\n      // assume additional smaller events across week: recent + 0.5 * recent * 2\n      weekly = Math.round((result.recentSnowfall + Math.max(0, result.recentSnowfall * 1.0)) * 2) / 2;\n    }\n    // Adjust weekly estimate for station distance (reduce confidence if station is far)\n    const stationDist = (extra && typeof extra.stationDistanceKm === 'number') ? extra.stationDistanceKm : null;\n    if (stationDist != null && stationDist > 50) {\n      // Reduce estimate progressively for stations further away. Start conservatively at 50km.\n      // 50-150km -> reduce up to 30%, >=150km reduce up to 40%.\n      let reduction = 0.1;\n      if (stationDist >= 150) reduction = 0.4;\n      else reduction = 0.1 + Math.min(0.3, ((stationDist - 50) / 100) * 0.3);\n      weekly = Math.max(0, weekly * (1 - reduction));\n      result.factors.push('station-distance');\n    }\n  result.weeklySnowfall = Math.max(0, Math.round(weekly * 2) / 2);\n  // attach computed weekly snow/rain totals (in inches)\n  result.weeklySnowIn = Math.max(0, Math.round((weeklySnowIn) * 2) / 2);\n  result.weeklyRainIn = Math.max(0, Math.round((weeklyRainIn) * 100) / 100);\n\n    // If the caller provided a resort-reported weekly total (on-mountain report), blend\n    // the model's weekly estimate with that report. This biases the estimate toward\n    // resort-reported values when available while retaining model signals.\n    // Default weight favors resort report moderately (resortWeight = 0.7) but this\n    // can be tuned externally by callers if desired.\n    if (extra && typeof extra.resortReportedWeekly === 'number' && extra.resortReportedWeekly !== null) {\n      const resortVal = Math.max(0, extra.resortReportedWeekly);\n      const modelVal = typeof result.weeklySnowfall === 'number' ? result.weeklySnowfall : 0;\n      // Allow caller to override the resort weight; default to 0.7 for moderate trust.\n      let resortWeight = 0.7;\n      if (typeof (extra as any).resortWeight === 'number' && (extra as any).resortWeight >= 0 && (extra as any).resortWeight <= 1) {\n        resortWeight = (extra as any).resortWeight;\n      }\n      const blended = Math.round(((resortVal * resortWeight) + (modelVal * (1 - resortWeight))) * 2) / 2;\n      result.factors.push('resort-reported');\n      result.factors.push(`resort-weight:${resortWeight}`);\n      result.weeklySnowfall = blended;\n    }\n\n    // Estimate expected on-ground depth after melt/compaction using environmental factors\n    // Start from reported/estimated snowDepth\n    const baseDepth = result.snowDepth || 0;\n    let retention = 1.0;\n    // temp effect (use avgTemp7d if available)\n    const avgTempC = (extra && typeof extra.avgTemp7d === 'number') ? extra.avgTemp7d : null;\n    if (avgTempC != null) {\n      if (avgTempC > 0) retention *= 0.6; // above freezing average -> significant melt\n      else if (avgTempC > -2) retention *= 0.85; // near-freezing\n      else retention *= 1.0; // cold preserves\n    }\n    // wind effect\n    const avgWindKph = (extra && typeof extra.avgWind7d === 'number') ? extra.avgWind7d : null;\n    if (avgWindKph != null) {\n      const avgWindMph = avgWindKph * 0.621371;\n      if (avgWindMph > 40) retention *= 0.7;\n      else if (avgWindMph > 25) retention *= 0.85;\n    }\n    // sun exposure\n    const avgSun = (extra && typeof extra.avgSunHours7d === 'number') ? extra.avgSunHours7d : null;\n    if (avgSun != null) {\n      if (avgSun > 4) retention *= 0.85;\n      else if (avgSun > 2) retention *= 0.95;\n    }\n    // elevation effect (higher => better retention)\n    const elev = (extra && typeof extra.elevationFt === 'number') ? extra.elevationFt : null;\n    if (elev != null) {\n      const boost = 1 + Math.max(0, Math.min(0.3, (elev - 1000) / 10000));\n      retention *= boost;\n    }\n    // age/compaction: if no fresh snow recently, compact\n    if (result.recentSnowfall <= 1) retention *= 0.95;\n\n    result.expectedOnGround = Math.round(Math.max(0, baseDepth * retention) * 10) / 10;\n\n    return result;\n  }\n\nexport default {\n  predictFromNWS,\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 884, "column": 0}, "map": {"version":3,"sources":["file:///Users/ryanbartell/ski-conditions-aggregator/app/api/scrape/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport * as cheerio from 'cheerio';\nimport { resorts } from '../../../lib/resorts';\nimport { Conditions } from '../../../lib/types';\nimport { getNWSObservation, NWSObservation } from '../../../lib/nws';\nimport { getHistoricalObservations } from '../../../lib/nws';\nimport snowModel from '../../../lib/snowModel';\n\n// Resort-specific scraping removed. All logic now uses NWS-based predictive model.\nasync function scrapeResortConditions(url: string, resortId?: string): Promise<any> {\n  // No-op: always return zeros/nulls for legacy fields\n  return { snowDepth: 0, recentSnowfall: 0, trailOpen: 0, trailTotal: 0, groomed: 0, baseTemp: null, windSpeed: null, visibility: null, rawHtml: null };\n}\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url);\n  const resortId = searchParams.get('resortId');\n\n  if (!resortId) {\n    return NextResponse.json({ error: 'resortId required' }, { status: 400 });\n  }\n\n  const resort = resorts.find(r => r.id === resortId);\n  if (!resort) {\n    return NextResponse.json({ error: 'Resort not found' }, { status: 404 });\n  }\n\n  try {\n    // Fetch NWS weather for observation and let the local model predict snowfall/conditions\n    let nws: NWSObservation | null = null;\n    try {\n      nws = await getNWSObservation(resort.lat, resort.lon);\n    } catch (e) {\n      nws = null;\n    }\n\n    // Predict using our snow model (deterministic heuristics + optional extra inputs)\n    // Attempt to fetch historical observations for the resort (last 7 days) to improve weekly totals\n    let extra: any = {};\n    // Allow callers to pass resort-reported weekly totals and a resort weight to bias the model.\n    try {\n      const urlObj = new URL(request.url);\n      const rp = urlObj.searchParams.get('resortReportedWeekly');\n      const rw = urlObj.searchParams.get('resortWeight');\n      if (rp != null) {\n        const parsed = parseFloat(rp as string);\n        if (!Number.isNaN(parsed)) extra.resortReportedWeekly = parsed;\n      }\n      if (rw != null) {\n        const parsed = parseFloat(rw as string);\n        if (!Number.isNaN(parsed)) extra.resortWeight = parsed;\n      }\n    } catch (e) {\n      // ignore\n    }\n    try {\n      const hist = await getHistoricalObservations(resort.lat, resort.lon, 7);\n      if (hist && Array.isArray(hist.observations) && hist.observations.length > 0) {\n        const weeklyObs: any[] = [];\n        let weeklyPrecipMm = 0;\n        for (const f of hist.observations) {\n          const p = f.properties || f;\n          const precipMm = (p.precipitationLastHour && typeof p.precipitationLastHour.value === 'number') ? p.precipitationLastHour.value : (p.precipitation && typeof p.precipitation.value === 'number' ? p.precipitation.value : null);\n          const tempC = (p.temperature && typeof p.temperature.value === 'number') ? p.temperature.value : (typeof p.temperature === 'number' ? p.temperature : null);\n          const windKph = (p.windSpeed && typeof p.windSpeed.value === 'number') ? (p.windSpeed.value * 3.6) : null; // m/s -> kph\n          weeklyObs.push({ precipMm: precipMm, tempC: tempC, windKph, timestamp: p.timestamp || p.validTime || null });\n          if (typeof precipMm === 'number') weeklyPrecipMm += precipMm;\n        }\n        extra.weeklyObservations = weeklyObs;\n        extra.weeklyPrecipMm = weeklyPrecipMm;\n        extra.avgTemp7d = weeklyObs.reduce((s, o) => s + (o.tempC ?? 0), 0) / Math.max(1, weeklyObs.length);\n        extra.avgWind7d = weeklyObs.reduce((s, o) => s + (o.windKph ?? 0), 0) / Math.max(1, weeklyObs.length);\n        extra.elevationFt = resort.elevationFt ?? null;\n        extra.stationDistanceKm = hist.stationDistanceKm;\n      }\n    } catch (e) {\n      // keep any previously collected extra fields (e.g., resortReportedWeekly/resortWeight)\n      // but if historical fetch failed we simply proceed with what we have.\n    }\n\n  const pred = snowModel.predictFromNWS(nws, extra);\n\n    // Trail data is not available from our sources, so set to 0\n    const trailOpen = 0;\n    const trailTotal = 0;\n    const groomed = 0;\n\n    const conditions: Conditions = {\n      resortId,\n      timestamp: new Date(),\n      snowDepth: pred.snowDepth,\n      recentSnowfall: pred.recentSnowfall,\n      weeklySnowfall: pred.weeklySnowfall ?? 0,\n      expectedOnGround: pred.expectedOnGround ?? pred.snowDepth,\n      baseTemp: pred.baseTemp ?? 0,\n      windSpeed: pred.windSpeed ?? 0,\n      visibility: pred.visibility,\n      trailStatus: { open: trailOpen, total: trailTotal, groomed },\n      rawData: { nws, model: pred },\n    };\n\n    // TODO: Store in Supabase\n\n    return NextResponse.json(conditions);\n  } catch (error) {\n    // If error is from scraping, return a clear error message\n    return NextResponse.json({ error: (error as Error).message, type: 'scrape-failed' }, { status: 502 });\n  }\n}"],"names":[],"mappings":"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"}}]
}