{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ryanbartell/ski-conditions-aggregator/app/api/radar/tile/route.ts"],"sourcesContent":["import { NextResponse, NextRequest } from 'next/server';\n\nexport const dynamic = 'force-dynamic';\n\n/**\n * Radar Tile Proxy - Returns radar tile images\n * \n * Primary Source: RainViewer API v2 (48-hour history)\n * Fallback: Iowa State Mesonet (1-hour history)\n * \n * RainViewer Layer Format: { timestamp: ms, url: \"tile URL pattern\" }\n * Mesonet Layer Format: \"nexrad-n0q-mXXm\"\n * \n * Query Params:\n *   layer - Either RainViewer URL or Mesonet layer name\n *   z, x, y - Tile coordinates\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = request.nextUrl;\n    \n    const layer = searchParams.get('layer');\n    const z = searchParams.get('z');\n    const x = searchParams.get('x');\n    const y = searchParams.get('y');\n    \n    if (!z || !x || !y || !layer) {\n      return NextResponse.json(\n        { error: 'Missing parameters. Required: layer, z, x, y' },\n        { status: 400 }\n      );\n    }\n    \n    const zNum = parseInt(z);\n    const xNum = parseInt(x);\n    const yNum = parseInt(y);\n    \n    if (isNaN(zNum) || isNaN(xNum) || isNaN(yNum)) {\n      return NextResponse.json({ error: 'Invalid tile coordinates' }, { status: 400 });\n    }\n\n    if (zNum < 0 || zNum > 18) return getTransparentTile();\n    \n    const maxTile = Math.pow(2, zNum);\n    if (xNum < 0 || xNum >= maxTile || yNum < 0 || yNum >= maxTile) {\n      return getTransparentTile();\n    }\n\n    let tileUrl: string;\n\n    // DETECT SOURCE: RainViewer or Mesonet\n    if (layer.startsWith('http')) {\n      // RainViewer: layer is a URL template like \"https://tile.rainviewer.com/v2/radar/1704033600/{z}/{x}/{y}/...\"\n      // Replace {z}, {x}, {y} with actual coordinates\n      tileUrl = layer\n        .replace('{z}', String(zNum))\n        .replace('{x}', String(xNum))\n        .replace('{y}', String(yNum));\n      \n      console.log(`[Tile] RainViewer: z=${zNum} x=${xNum} y=${yNum}`);\n    } else if (layer.startsWith('nexrad-n0q')) {\n      // Mesonet: layer name like \"nexrad-n0q-m15m\"\n      // Validate Mesonet layer format\n      if (!/^nexrad-n0q(-m\\d{2}m)?$/.test(layer)) {\n        return NextResponse.json({ error: 'Invalid Mesonet layer' }, { status: 400 });\n      }\n\n      tileUrl = `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/${layer}/${zNum}/${xNum}/${yNum}.png`;\n      console.log(`[Tile] Mesonet: layer=${layer} z=${zNum}`);\n    } else {\n      return NextResponse.json({ error: 'Invalid layer format' }, { status: 400 });\n    }\n\n    // Fetch tile from source\n    const response = await fetch(tileUrl, {\n      headers: {\n        'User-Agent': 'ski-conditions-aggregator',\n        'Accept': 'image/png,image/webp,*/*'\n      },\n      next: { revalidate: 300 } // Cache 5 minutes\n    });\n\n    if (!response.ok) {\n      console.warn(`[Tile] Source returned ${response.status}`);\n      return getTransparentTile();\n    }\n\n    const imageBuffer = await response.arrayBuffer();\n    if (imageBuffer.byteLength === 0) return getTransparentTile();\n\n    return new NextResponse(imageBuffer, {\n      headers: {\n        'Content-Type': 'image/png',\n        'Cache-Control': 'public, max-age=300',\n        'Access-Control-Allow-Origin': '*'\n      }\n    });\n\n  } catch (error: any) {\n    console.error('[Tile] Error:', error.message);\n    return getTransparentTile();\n  }\n}\n\nfunction getTransparentTile(): Response {\n  // 1x1 transparent PNG\n  const transparentPng = Buffer.from([\n    0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a,\n    0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,\n    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,\n    0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4,\n    0x89, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41,\n    0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,\n    0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00,\n    0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae,\n    0x42, 0x60, 0x82,\n  ]);\n  \n  return new NextResponse(transparentPng, {\n    headers: {\n      'Content-Type': 'image/png',\n      'Cache-Control': 'public, max-age=300',\n      'Access-Control-Allow-Origin': '*'\n    }\n  });\n}\n"],"names":[],"mappings":"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"}}]
}