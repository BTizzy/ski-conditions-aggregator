{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ryanbartell/ski-conditions-aggregator/app/api/radar/tile/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\n\n// Simple in-memory short-lived cache for the RainViewer frames JSON to avoid refetching on every tile request.\nlet framesCache: { ts: number; data: any } | null = null;\nconst FRAMES_CACHE_TTL = 60 * 1000; // 1 minute\n\n// In-memory tile cache: key -> { ts, contentType, buffer }\nconst tileCache: Map<string, { ts: number; contentType: string; buffer: Uint8Array }> = new Map();\nconst TILE_CACHE_TTL = 5 * 60 * 1000; // 5 minutes\n// Deduplicate concurrent fetches for the same tile\nconst pendingTileFetches: Map<string, Promise<Response>> = new Map();\n\nasync function fetchFramesList() {\n  const now = Date.now();\n  if (framesCache && (now - framesCache.ts) < FRAMES_CACHE_TTL) return framesCache.data;\n  try {\n    const res = await fetch('https://api.rainviewer.com/public/weather-maps.json', { headers: { 'User-Agent': 'ski-conditions-aggregator/1.0' } });\n    if (!res.ok) throw new Error('frames_fetch_failed');\n    const data = await res.json();\n    framesCache = { ts: now, data };\n    return data;\n  } catch (e) {\n    // keep existing cache if available\n    if (framesCache) return framesCache.data;\n    return null;\n  }\n}\n\nfunction pickNearestTime(requested: number, availableTimes: number[]) {\n  if (!availableTimes || availableTimes.length === 0) return requested;\n  let best = availableTimes[0];\n  let bestDiff = Math.abs(best - requested);\n  for (const t of availableTimes) {\n    const d = Math.abs(t - requested);\n    if (d < bestDiff) { best = t; bestDiff = d; }\n  }\n  return best;\n}\n\nexport async function GET(req: Request) {\n  try {\n    const url = new URL(req.url);\n    const timeParam = url.searchParams.get('time');\n    const z = url.searchParams.get('z');\n    const x = url.searchParams.get('x');\n    const y = url.searchParams.get('y');\n    if (!timeParam || !z || !x || !y) {\n      return NextResponse.json({ error: 'missing_params' }, { status: 400 });\n    }\n\n    let requestedTime = Number(timeParam);\n    if (Number.isNaN(requestedTime)) requestedTime = parseInt(timeParam, 10) || 0;\n\n    // Try to fetch list of available frames and snap to nearest available time if requested is missing\n    const framesData = await fetchFramesList();\n    let availableTimes: number[] = [];\n    let preferredHost = 'https://tilecache.rainviewer.com';\n    if (framesData && framesData.radar) {\n      const past = framesData.radar.past || [];\n      const nowcast = framesData.radar.nowcast || [];\n      const times = [] as number[];\n      for (const f of past) { times.push((f && (f.time || f)) || 0); }\n      for (const f of nowcast) { times.push((f && (f.time || f)) || 0); }\n      availableTimes = times.filter(Boolean).sort((a,b)=>a-b);\n      if (framesData.host) preferredHost = framesData.host.replace(/\\/+$/, '');\n    }\n\n    // If requested time is not in availableTimes, pick nearest available (to reduce 404s)\n    let usedTime = requestedTime;\n    if (availableTimes.length > 0 && !availableTimes.includes(requestedTime)) {\n      usedTime = pickNearestTime(requestedTime, availableTimes);\n    }\n\n  // Try multiple candidate hosts to increase chance of finding a tile\n  const hostsToTry = [preferredHost, 'https://tile.rainviewer.com', 'https://tilecache.rainviewer.com'];\n  // Some RainViewer tile variants include extra path segments (e.g. \"/2/1_0.png\"). Try a few common suffix patterns.\n  const tileSuffixes = ['{z}/{x}/{y}.png', '{z}/{x}/{y}/2/1_0.png', '{z}/{x}/{y}/2/0_0.png'];\n    const tried: Array<{ host: string; status: number; url: string }> = [];\n\n    const headers = {\n      'User-Agent': 'ski-conditions-aggregator/1.0 (+https://localhost)',\n      'Accept': 'image/avif,image/webp,image/apng,image/*,*/*;q=0.8',\n      // Some RainViewer tiles may require a referer; use the public site origin which is commonly accepted\n      'Referer': 'https://www.rainviewer.com/',\n    };\n    for (const host of hostsToTry) {\n      const sanitizedHost = host.replace(/\\/+$/, '');\n      for (const suffixTemplate of tileSuffixes) {\n        const suffix = suffixTemplate.replace('{z}', encodeURIComponent(z)).replace('{x}', encodeURIComponent(x)).replace('{y}', encodeURIComponent(y));\n        const tileUrl = `${sanitizedHost}/v2/radar/${encodeURIComponent(usedTime)}/${suffix}`;\n\n        // Check in-memory cache first\n        try {\n          const cached = tileCache.get(tileUrl);\n          if (cached && (Date.now() - cached.ts) < TILE_CACHE_TTL) {\n            const respHeaders = new Headers();\n            respHeaders.set('Content-Type', cached.contentType || 'image/png');\n            respHeaders.set('Cache-Control', 'public, max-age=60');\n            respHeaders.set('Access-Control-Allow-Origin', '*');\n            respHeaders.set('Access-Control-Expose-Headers', 'X-RainViewer-Used-Host,X-RainViewer-Used-Time,X-RainViewer-Used-Suffix,X-Cache');\n            respHeaders.set('X-RainViewer-Used-Host', sanitizedHost);\n            respHeaders.set('X-RainViewer-Used-Time', String(usedTime));\n            respHeaders.set('X-Cache', 'HIT');\n            return new Response(Buffer.from(cached.buffer), { status: 200, headers: respHeaders });\n          }\n        } catch (e) {\n          // ignore cache read errors and continue\n        }\n\n        // If there is already a pending fetch for this exact URL, await and return it\n        if (pendingTileFetches.has(tileUrl)) {\n          try {\n            const pendingPromise = pendingTileFetches.get(tileUrl);\n            if (pendingPromise) {\n              const pendingResp = await pendingPromise;\n              try { return pendingResp.clone(); } catch (e) { return pendingResp; }\n            }\n          } catch (e) {\n            // fall through to attempting fetch again\n          }\n        }\n\n        // perform fetch and record it in pending map to dedupe concurrent requests\n        const fetchPromise = (async () => {\n          try {\n            const upstream = await fetch(tileUrl, { headers });\n            if (upstream.ok) {\n              const arrayBuffer = await upstream.arrayBuffer();\n              const buffer = new Uint8Array(arrayBuffer);\n              const ct = upstream.headers.get('content-type') || 'image/png';\n\n              // store in cache\n              try {\n                tileCache.set(tileUrl, { ts: Date.now(), contentType: ct, buffer });\n              } catch (e) {}\n\n              const respHeaders = new Headers();\n              respHeaders.set('Content-Type', ct);\n              respHeaders.set('Cache-Control', 'public, max-age=60');\n              respHeaders.set('Access-Control-Allow-Origin', '*');\n              respHeaders.set('Access-Control-Expose-Headers', 'X-RainViewer-Used-Host,X-RainViewer-Used-Time,X-RainViewer-Used-Suffix,X-Cache');\n              respHeaders.set('X-RainViewer-Used-Host', sanitizedHost);\n              respHeaders.set('X-RainViewer-Used-Time', String(usedTime));\n              respHeaders.set('X-RainViewer-Used-Suffix', suffixTemplate);\n              respHeaders.set('X-Cache', 'MISS');\n              return new Response(Buffer.from(buffer), { status: 200, headers: respHeaders });\n            }\n            tried.push({ host: sanitizedHost, status: upstream.status, url: tileUrl });\n            return new Response(JSON.stringify({ error: 'upstream_tile_error', status: upstream.status, url: tileUrl }), { status: 502, headers: { 'Content-Type': 'application/json' } });\n          } catch (e: any) {\n            tried.push({ host: sanitizedHost, status: 0, url: tileUrl });\n            return new Response(JSON.stringify({ error: 'upstream_tile_error', status: 0, url: tileUrl }), { status: 502, headers: { 'Content-Type': 'application/json' } });\n          } finally {\n            // cleanup pending map entry after a short delay to allow clones\n            setTimeout(() => { pendingTileFetches.delete(tileUrl); }, 1000);\n          }\n        })();\n\n        pendingTileFetches.set(tileUrl, fetchPromise as Promise<Response>);\n        const resp = await fetchPromise;\n        // If we returned a successful image Response from inside fetchPromise, return it (clone to allow reuse)\n        try { return resp.clone(); } catch (e) { return resp; }\n      }\n    }\n\n    // As a final fallback, try OpenWeather precipitation tiles if an API key is available.\n    try {\n      const owKey = process.env.OPENWEATHER_API_KEY || '';\n      if (owKey) {\n        const owUrl = `https://tile.openweathermap.org/map/precipitation_new/${encodeURIComponent(z)}/${encodeURIComponent(x)}/${encodeURIComponent(y)}.png?appid=${encodeURIComponent(owKey)}`;\n        try {\n          const owResp = await fetch(owUrl, { headers: { 'User-Agent': 'ski-conditions-aggregator/1.0' } });\n          if (owResp.ok) {\n            const ct = owResp.headers.get('content-type') || 'image/png';\n            const respHeaders = new Headers();\n            respHeaders.set('Content-Type', ct);\n            respHeaders.set('Cache-Control', 'public, max-age=60');\n            respHeaders.set('Access-Control-Allow-Origin', '*');\n            respHeaders.set('Access-Control-Expose-Headers', 'X-RainViewer-Used-Host,X-RainViewer-Used-Time,X-RainViewer-Used-Suffix,X-Cache');\n            respHeaders.set('X-RainViewer-Used-Host', 'openweathermap');\n            respHeaders.set('X-RainViewer-Used-Time', String(usedTime));\n            return new Response(owResp.body, { status: 200, headers: respHeaders });\n          }\n          tried.push({ host: 'openweathermap', status: owResp.status, url: owUrl });\n        } catch (e: any) {\n          tried.push({ host: 'openweathermap', status: 0, url: owUrl });\n        }\n      }\n    } catch (e) {\n      // ignore final-fallback errors\n    }\n\n    // If we reach here, no host returned a tile\n    return NextResponse.json({ error: 'upstream_tile_error', tried }, { status: 502 });\n  } catch (e: any) {\n    return NextResponse.json({ error: 'proxy_failed', message: String(e) }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}