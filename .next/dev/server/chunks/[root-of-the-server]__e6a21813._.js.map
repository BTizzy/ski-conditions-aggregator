{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/ski-conditions-aggregator/ski-conditions-aggregator/app/api/radar/lib/interpolation.ts"],"sourcesContent":["// IDW (Inverse Distance Weighting) interpolation for gridded radar tiles\n// See COPILOT_PROMPT.md for methodology and requirements\n\nexport interface Point {\n  lat: number;\n  lon: number;\n  value: number;\n}\n\nexport interface Grid {\n  width: number;\n  height: number;\n  lat0: number; // NW corner\n  lon0: number; // NW corner\n  lat1: number; // SE corner\n  lon1: number; // SE corner\n  data: number[][]; // [y][x] grid of interpolated values\n}\n\nexport interface IDWOptions {\n  power?: number; // IDW power parameter (default 2)\n  radius?: number; // Max distance in km to consider (optional)\n  minPoints?: number; // Minimum points to interpolate (default 1)\n  nodata?: number; // Value to use if no points in radius (default NaN)\n}\n\n// Haversine distance in km\nfunction haversine(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 6371;\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLon = (lon2 - lon1) * Math.PI / 180;\n  const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) ** 2;\n  return 2 * R * Math.asin(Math.sqrt(a));\n}\n\n// IDW interpolation for a grid\nexport function idwGrid(\n  points: Point[],\n  width: number,\n  height: number,\n  lat0: number,\n  lon0: number,\n  lat1: number,\n  lon1: number,\n  options: IDWOptions = {}\n): Grid {\n  const power = options.power ?? 2;\n  const radius = options.radius ?? Infinity;\n  const minPoints = options.minPoints ?? 1;\n  const nodata = options.nodata ?? NaN;\n  const data: number[][] = [];\n  for (let y = 0; y < height; y++) {\n    const row: number[] = [];\n    const lat = lat0 + (lat1 - lat0) * (y / (height - 1));\n    for (let x = 0; x < width; x++) {\n      const lon = lon0 + (lon1 - lon0) * (x / (width - 1));\n      // Compute weights\n      let sumWeights = 0;\n      let sumValues = 0;\n      let used = 0;\n      for (const pt of points) {\n        const d = haversine(lat, lon, pt.lat, pt.lon);\n        if (d === 0) {\n          row.push(pt.value);\n          used = -1;\n          break;\n        }\n        if (d <= radius) {\n          const w = 1 / Math.pow(d, power);\n          sumWeights += w;\n          sumValues += w * pt.value;\n          used++;\n        }\n      }\n      if (used === -1) continue;\n      if (used >= minPoints && sumWeights > 0) {\n        row.push(sumValues / sumWeights);\n      } else {\n        row.push(nodata);\n      }\n    }\n    data.push(row);\n  }\n  return { width, height, lat0, lon0, lat1, lon1, data };\n}\n"],"names":[],"mappings":"AAAA,yEAAyE;AACzE,yDAAyD;;;;;AAyBzD,2BAA2B;AAC3B,SAAS,UAAU,IAAY,EAAE,IAAY,EAAE,IAAY,EAAE,IAAY;IACvE,MAAM,IAAI;IACV,MAAM,OAAO,CAAC,OAAO,IAAI,IAAI,KAAK,EAAE,GAAG;IACvC,MAAM,OAAO,CAAC,OAAO,IAAI,IAAI,KAAK,EAAE,GAAG;IACvC,MAAM,IAAI,KAAK,GAAG,CAAC,OAAK,MAAM,IAAI,KAAK,GAAG,CAAC,OAAO,KAAK,EAAE,GAAC,OAAO,KAAK,GAAG,CAAC,OAAO,KAAK,EAAE,GAAC,OAAO,KAAK,GAAG,CAAC,OAAK,MAAM;IACpH,OAAO,IAAI,IAAI,KAAK,IAAI,CAAC,KAAK,IAAI,CAAC;AACrC;AAGO,SAAS,QACd,MAAe,EACf,KAAa,EACb,MAAc,EACd,IAAY,EACZ,IAAY,EACZ,IAAY,EACZ,IAAY,EACZ,UAAsB,CAAC,CAAC;IAExB,MAAM,QAAQ,QAAQ,KAAK,IAAI;IAC/B,MAAM,SAAS,QAAQ,MAAM,IAAI;IACjC,MAAM,YAAY,QAAQ,SAAS,IAAI;IACvC,MAAM,SAAS,QAAQ,MAAM,IAAI;IACjC,MAAM,OAAmB,EAAE;IAC3B,IAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,IAAK;QAC/B,MAAM,MAAgB,EAAE;QACxB,MAAM,MAAM,OAAO,CAAC,OAAO,IAAI,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QACpD,IAAK,IAAI,IAAI,GAAG,IAAI,OAAO,IAAK;YAC9B,MAAM,MAAM,OAAO,CAAC,OAAO,IAAI,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACnD,kBAAkB;YAClB,IAAI,aAAa;YACjB,IAAI,YAAY;YAChB,IAAI,OAAO;YACX,KAAK,MAAM,MAAM,OAAQ;gBACvB,MAAM,IAAI,UAAU,KAAK,KAAK,GAAG,GAAG,EAAE,GAAG,GAAG;gBAC5C,IAAI,MAAM,GAAG;oBACX,IAAI,IAAI,CAAC,GAAG,KAAK;oBACjB,OAAO,CAAC;oBACR;gBACF;gBACA,IAAI,KAAK,QAAQ;oBACf,MAAM,IAAI,IAAI,KAAK,GAAG,CAAC,GAAG;oBAC1B,cAAc;oBACd,aAAa,IAAI,GAAG,KAAK;oBACzB;gBACF;YACF;YACA,IAAI,SAAS,CAAC,GAAG;YACjB,IAAI,QAAQ,aAAa,aAAa,GAAG;gBACvC,IAAI,IAAI,CAAC,YAAY;YACvB,OAAO;gBACL,IAAI,IAAI,CAAC;YACX;QACF;QACA,KAAK,IAAI,CAAC;IACZ;IACA,OAAO;QAAE;QAAO;QAAQ;QAAM;QAAM;QAAM;QAAM;IAAK;AACvD"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/ski-conditions-aggregator/ski-conditions-aggregator/lib/resorts.ts"],"sourcesContent":["export interface Resort {\n  id: string;\n  name: string;\n  state: string;\n  lat: number;\n  lon: number;\n  // Elevations: optionally provide base and summit elevations. If both present, `elevationFt` will be computed\n  baseElevationFt?: number; // feet at base / lodge\n  summitElevationFt?: number; // feet at summit\n  elevationFt?: number; // computed midpoint between base and summit when both are provided\n  scrapeUrl: string; // Homepage for scraping conditions (legacy)\n  conditionsUrl?: string; // canonical conditions page (optional)\n  logoUrl?: string;\n}\n\nexport const resorts: Resort[] = [\n  // --- Top Priority Resorts ---\n  {\n    id: 'loon-mountain',\n    name: 'Loon Mountain',\n    state: 'NH',\n    lat: 44.0367,\n    lon: -71.6217,\n    scrapeUrl: 'https://www.loonmtn.com/mountain-info/conditions',\n  },\n  {\n    id: 'sunday-river',\n    name: 'Sunday River',\n    state: 'ME',\n    lat: 44.4722,\n    lon: -70.8567,\n    scrapeUrl: 'https://www.sundayriver.com/mountain-info/conditions',\n  },\n  {\n    id: 'sugarloaf',\n    name: 'Sugarloaf',\n    state: 'ME',\n    lat: 45.0311,\n    lon: -70.3133,\n    scrapeUrl: 'https://www.sugarloaf.com/conditions',\n  },\n  // --- Major Vermont Resorts ---\n  {\n    id: 'stowe',\n    name: 'Stowe',\n    state: 'VT',\n    lat: 44.4654,\n    lon: -72.6874,\n    scrapeUrl: 'https://www.stowe.com/the-mountain/mountain-conditions/',\n  },\n  {\n    id: 'killington',\n    name: 'Killington',\n    state: 'VT',\n    lat: 43.6045,\n    lon: -72.8201,\n    scrapeUrl: 'https://www.killington.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'sugarbush',\n    name: 'Sugarbush',\n    state: 'VT',\n    lat: 44.1436,\n    lon: -72.8944,\n    scrapeUrl: 'https://www.sugarbush.com/mountain-info/conditions/',\n  },\n  {\n    id: 'okemo',\n    name: 'Okemo',\n    state: 'VT',\n    lat: 43.4036,\n    lon: -72.7202,\n    scrapeUrl: 'https://www.okemo.com/the-mountain/mountain-conditions/',\n  },\n  {\n    id: 'mount-snow',\n    name: 'Mount Snow',\n    state: 'VT',\n    lat: 42.9606,\n    lon: -72.9205,\n    scrapeUrl: 'https://www.mountsnow.com/the-mountain/mountain-conditions/',\n  },\n  {\n    id: 'stratton',\n    name: 'Stratton',\n    state: 'VT',\n    lat: 43.1135,\n    lon: -72.9205,\n    scrapeUrl: 'https://www.stratton.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'jay-peak',\n    name: 'Jay Peak',\n    state: 'VT',\n    lat: 44.9242,\n    lon: -72.5316,\n    scrapeUrl: 'https://jaypeakresort.com/ski-ride/conditions',\n  },\n  {\n    id: 'smugglers-notch',\n    name: \"Smugglers' Notch\",\n    state: 'VT',\n    lat: 44.5884,\n    lon: -72.7815,\n    scrapeUrl: 'https://www.smuggs.com/pages/winter/skiride/conditions.php',\n  },\n  {\n    id: 'bromley',\n    name: 'Bromley',\n    state: 'VT',\n    lat: 43.2137,\n    lon: -72.9362,\n    scrapeUrl: 'https://www.bromley.com/the-mountain/conditions/',\n  },\n  {\n    id: 'mad-river-glen',\n    name: 'Mad River Glen',\n    state: 'VT',\n    lat: 44.2019,\n    lon: -72.9172,\n    scrapeUrl: 'https://www.madriverglen.com/mountain-info/conditions',\n  },\n  // --- Major New Hampshire Resorts ---\n  {\n    id: 'bretton-woods',\n    name: 'Bretton Woods',\n    state: 'NH',\n    lat: 44.2547,\n    lon: -71.4417,\n    scrapeUrl: 'https://www.brettonwoods.com/mountain-info/conditions',\n  },\n  {\n    id: 'cannon-mountain',\n    name: 'Cannon Mountain',\n    state: 'NH',\n    lat: 44.1786,\n    lon: -71.6981,\n    scrapeUrl: 'https://www.cannonmt.com/mountain-info/conditions',\n  },\n  {\n    id: 'waterville-valley',\n    name: 'Waterville Valley',\n    state: 'NH',\n    lat: 43.9506,\n    lon: -71.5072,\n    scrapeUrl: 'https://www.waterville.com/mountain-report',\n  },\n  {\n    id: 'wildcat',\n    name: 'Wildcat',\n    state: 'NH',\n    lat: 44.2581,\n    lon: -71.2256,\n    scrapeUrl: 'https://www.skiwildcat.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'attitash',\n    name: 'Attitash',\n    state: 'NH',\n    lat: 44.0822,\n    lon: -71.2292,\n    scrapeUrl: 'https://www.attitash.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'cranmore',\n    name: 'Cranmore',\n    state: 'NH',\n    lat: 44.0584,\n    lon: -71.1284,\n    scrapeUrl: 'https://www.cranmore.com/conditions',\n  },\n  // --- Southern New Hampshire additions ---\n  {\n    id: 'pats-peak',\n    name: \"Pats Peak\",\n    state: 'NH',\n    lat: 43.0740,\n    lon: -71.7508,\n    // approximate base and summit elevations (ft). These are best-effort values and can be updated later.\n    baseElevationFt: 620,\n    summitElevationFt: 1030,\n    scrapeUrl: 'https://www.patspeak.com',\n    conditionsUrl: 'https://www.patspeak.com/conditions',\n  },\n  {\n    id: 'mount-sunapee',\n    name: 'Mount Sunapee',\n    state: 'NH',\n    lat: 43.3337,\n    lon: -72.0586,\n    baseElevationFt: 1600,\n    summitElevationFt: 2743,\n    scrapeUrl: 'https://www.mountsunapee.com',\n    conditionsUrl: 'https://www.mountsunapee.com/mountain/conditions',\n  },\n  {\n    id: 'gunstock',\n    name: 'Gunstock',\n    state: 'NH',\n    lat: 43.5792,\n    lon: -71.4246,\n    baseElevationFt: 600,\n    summitElevationFt: 2240,\n    scrapeUrl: 'https://www.gunstock.com',\n    conditionsUrl: 'https://www.gunstock.com/mountain-report',\n  },\n  {\n    id: 'crotched-mountain',\n    name: 'Crotched Mountain',\n    state: 'NH',\n    lat: 42.8537,\n    lon: -71.6146,\n    baseElevationFt: 400,\n    summitElevationFt: 2066,\n    scrapeUrl: 'https://www.crotchedmountain.org',\n    conditionsUrl: 'https://www.crotchedmountain.org/mountain-report',\n  },\n  {\n    id: 'mcintyre',\n    name: 'McIntyre Ski Area',\n    state: 'NH',\n    lat: 42.9955,\n    lon: -71.4601,\n    baseElevationFt: 200,\n    summitElevationFt: 350,\n    scrapeUrl: 'https://www.mcintyreskiarea.com',\n    conditionsUrl: 'https://www.mcintyreskiarea.com/conditions',\n  },\n  {\n    id: 'ragged-mountain',\n    name: 'Ragged Mountain',\n    state: 'NH',\n    lat: 43.2986,\n    lon: -71.8514,\n    baseElevationFt: 600,\n    summitElevationFt: 1350,\n    scrapeUrl: 'https://skiragged.com',\n    conditionsUrl: 'https://skiragged.com/mountain-report',\n  },\n  // --- Additional Maine Resorts ---\n  {\n    id: 'saddleback',\n    name: 'Saddleback',\n    state: 'ME',\n    lat: 44.9531,\n    lon: -70.5272,\n    scrapeUrl: 'https://www.saddlebackmaine.com/conditions/',\n  },\n  {\n    id: 'squaw-mountain',\n    name: 'Squaw Mountain',\n    state: 'ME',\n    lat: 44.0822,\n    lon: -70.7567,\n    scrapeUrl: 'https://www.squawmt.com/conditions/',\n  },\n  // --- Massachusetts Resorts ---\n  {\n    id: 'jiminy-peak',\n    name: 'Jiminy Peak',\n    state: 'MA',\n    lat: 42.5556,\n    lon: -73.2922,\n    scrapeUrl: 'https://www.jiminypeak.com/mountain/conditions',\n  },\n  {\n    id: 'wachusett',\n    name: 'Wachusett',\n    state: 'MA',\n    lat: 42.5031,\n    lon: -71.8867,\n    scrapeUrl: 'https://www.wachusett.com/The-Mountain/Conditions.aspx',\n  },\n  // --- New York Resorts ---\n  {\n    id: 'whiteface',\n    name: 'Whiteface',\n    state: 'NY',\n    lat: 44.3656,\n    lon: -73.9022,\n    scrapeUrl: 'https://whiteface.com/conditions',\n  },\n  {\n    id: 'gore-mountain',\n    name: 'Gore Mountain',\n    state: 'NY',\n    lat: 43.6747,\n    lon: -74.0061,\n    scrapeUrl: 'https://goremountain.com/conditions/',\n  },\n  {\n    id: 'hunter-mountain',\n    name: 'Hunter Mountain',\n    state: 'NY',\n    lat: 42.2022,\n    lon: -74.2331,\n    scrapeUrl: 'https://www.huntermtn.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'windham-mountain',\n    name: 'Windham Mountain',\n    state: 'NY',\n    lat: 42.2917,\n    lon: -74.2581,\n    scrapeUrl: 'https://www.windhammountain.com/the-mountain/mountain-conditions',\n  },\n  {\n    id: 'belleayre',\n    name: 'Belleayre',\n    state: 'NY',\n    lat: 42.1356,\n    lon: -74.5061,\n    scrapeUrl: 'https://www.belleayre.com/conditions/',\n  },\n  // --- Pennsylvania Resorts ---\n  {\n    id: 'jack-frost-big-boulder',\n    name: 'Jack Frost Big Boulder',\n    state: 'PA',\n    lat: 41.1081,\n    lon: -75.6581,\n    scrapeUrl: 'https://www.jfbb.com/conditions/',\n  },\n  {\n    id: 'elk-mountain',\n    name: 'Elk Mountain',\n    state: 'PA',\n    lat: 41.7131,\n    lon: -75.5781,\n    scrapeUrl: 'https://www.elkskier.com/conditions/',\n  },\n  {\n    id: 'blue-mountain',\n    name: 'Blue Mountain',\n    state: 'PA',\n    lat: 40.8117,\n    lon: -75.5217,\n    scrapeUrl: 'https://www.skibluemt.com/mountain-report/',\n  },\n  {\n    id: 'seven-springs',\n    name: 'Seven Springs',\n    state: 'PA',\n    lat: 40.0231,\n    lon: -79.2981,\n    scrapeUrl: 'https://www.7springs.com/conditions/',\n  },\n  // --- Connecticut Resorts ---\n  {\n    id: 'mount-southington',\n    name: 'Mount Southington',\n    state: 'CT',\n    lat: 41.5992,\n    lon: -72.9272,\n    scrapeUrl: 'https://mountsouthington.com/conditions/',\n  },\n  {\n    id: 'powder-ridge',\n    name: 'Powder Ridge',\n    state: 'CT',\n    lat: 41.4992,\n    lon: -72.8272,\n    scrapeUrl: 'https://www.powderridgepark.com/conditions/',\n  },\n  // --- New Jersey Resorts ---\n  {\n    id: 'mountain-creek',\n    name: 'Mountain Creek',\n    state: 'NJ',\n    lat: 41.1822,\n    lon: -74.5081,\n    scrapeUrl: 'https://www.mountaincreek.com/mountain/conditions/',\n  },\n  {\n    id: 'campgaw-mountain',\n    name: 'Campgaw Mountain',\n    state: 'NJ',\n    lat: 41.0481,\n    lon: -74.2081,\n    scrapeUrl: 'https://www.campgaw.com/conditions/',\n  },\n  // --- Additional New Hampshire Resorts ---\n  {\n    id: 'black-mountain',\n    name: 'Black Mountain',\n    state: 'NH',\n    lat: 44.1667,\n    lon: -71.1667,\n    scrapeUrl: 'https://www.blackmt.com/conditions/',\n  },\n];\n\n// Post-process to compute elevationFt for entries that provide base+summit\nfor (const r of resorts) {\n  if (r.baseElevationFt !== undefined && r.summitElevationFt !== undefined && (r.elevationFt === undefined || r.elevationFt === null)) {\n    // midpoint elevation (average) between base lodge and summit\n    r.elevationFt = Math.round(((r.baseElevationFt + r.summitElevationFt) / 2) * 10) / 10;\n  }\n\n  // Keep object shape consistent: ensure elevationFt is number or undefined\n  if (r.elevationFt === undefined) delete r.elevationFt;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 505, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/ski-conditions-aggregator/ski-conditions-aggregator/app/api/radar/lib/historical.ts"],"sourcesContent":["// Historical NWS data fetching and processing for synthetic radar\n// Fetches past 48 hours of observations from all stations within 50 miles of each resort\n// Enhanced with OpenWeatherMap for better precipitation data\n\nimport { NWSObservation } from '../../../../lib/nws';\nimport { resorts } from '../../../../lib/resorts';\n\nexport interface HourlySnowfall {\n  timestamp: number; // Unix timestamp (ms)\n  snowfallIn: number; // Estimated snowfall inches for that hour\n  rainfallIn: number; // Estimated rainfall inches for that hour\n  lat: number;\n  lon: number;\n  stationId: string;\n}\n\nexport interface StationData {\n  stationId: string;\n  lat: number;\n  lon: number;\n  hourlyData: HourlySnowfall[];\n}\n\nexport interface ResortAreaData {\n  resortId: string;\n  stations: StationData[];\n}\n\n// Cache for resort area historical data\nlet cachedResortData: ResortAreaData[] | null = null;\nlet cacheTimestamp: number = 0;\nconst CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds\n\n// Haversine distance calculation\nfunction haversineDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 3959; // Earth's radius in miles\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLon = (lon2 - lon1) * Math.PI / 180;\n  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n    Math.sin(dLon/2) * Math.sin(dLon/2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n  return R * c;\n}\n\n// Find all weather stations within a radius using OpenWeatherMap API\nasync function findNearbyStations(lat: number, lon: number, radiusMiles: number = 50): Promise<{id: string, lat: number, lon: number}[]> {\n  try {\n    // Use OpenWeatherMap stations API to find stations near the location\n    const apiKey = process.env.OPENWEATHER_API_KEY;\n    if (!apiKey) {\n      console.warn('No OpenWeatherMap API key found, using fallback');\n      return [];\n    }\n\n    // Convert miles to meters for the API\n    const radiusMeters = radiusMiles * 1609.34;\n\n    const url = `https://api.openweathermap.org/data/2.5/station/find?lat=${lat}&lon=${lon}&cnt=50&appid=${apiKey}`;\n\n    const response = await fetch(url);\n\n    if (!response.ok) {\n      console.warn(`Failed to fetch stations near ${lat},${lon}: ${response.status}`);\n      return [];\n    }\n\n    const data = await response.json();\n    const stations: {id: string, lat: number, lon: number}[] = [];\n\n    for (const station of data || []) {\n      const stationLat = station.coord?.lat;\n      const stationLon = station.coord?.lon;\n      const stationId = station.id?.toString();\n\n      if (stationLat && stationLon && stationId) {\n        const distance = haversineDistance(lat, lon, stationLat, stationLon);\n        if (distance <= radiusMiles) {\n          stations.push({\n            id: stationId,\n            lat: stationLat,\n            lon: stationLon\n          });\n        }\n      }\n    }\n\n    console.log(`Found ${stations.length} stations within ${radiusMiles} miles of ${lat},${lon}`);\n    return stations;\n  } catch (error) {\n    console.error(`Error finding nearby stations:`, error);\n    return [];\n  }\n}\n\n// Fetch historical observations from OpenWeatherMap API for past 48 hours\nasync function fetchHistoricalObservations(stationId: string, stationLat: number, stationLon: number): Promise<NWSObservation[]> {\n  const apiKey = process.env.OPENWEATHER_API_KEY;\n  if (!apiKey) {\n    console.warn('No OpenWeatherMap API key found, using synthetic data');\n    return [];\n  }\n\n  try {\n    // Get 5-day forecast data (3-hour intervals) for better precipitation accuracy\n    const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${stationLat}&lon=${stationLon}&appid=${apiKey}&units=metric`;\n    const forecastResponse = await fetch(forecastUrl);\n\n    if (!forecastResponse.ok) {\n      if (forecastResponse.status === 429) {\n        console.warn(`OpenWeatherMap API error: 429 (rate limit exceeded) for station ${stationId}`);\n      } else {\n        console.warn(`OpenWeatherMap API error: ${forecastResponse.status} for station ${stationId}`);\n      }\n      return [];\n    }\n\n    const forecastData = await forecastResponse.json();\n\n    // Convert forecast data to observation format\n    const observations: NWSObservation[] = [];\n\n    for (const item of forecastData.list) {\n      // Extract precipitation data (rain and snow are separate in OpenWeatherMap)\n      const rainMm = item.rain?.['3h'] || 0; // Rain in last 3 hours\n      const snowMm = item.snow?.['3h'] || 0; // Snow in last 3 hours\n      const totalPrecipMm = rainMm + snowMm;\n\n      const observation: NWSObservation = {\n        timestamp: new Date(item.dt * 1000).toISOString(), // Convert Unix timestamp\n        temperature: item.main?.temp || null,\n        windSpeed: item.wind?.speed ? item.wind.speed * 3.6 : null, // Convert m/s to km/h\n        windDirection: item.wind?.deg || null,\n        textDescription: item.weather?.[0]?.description || 'Unknown',\n        icon: item.weather?.[0]?.icon || '',\n        raw: {\n          ...item,\n          precipitation: totalPrecipMm > 0 ? { value: totalPrecipMm, unitCode: 'mm' } : undefined,\n          temperature: item.main?.temp ? { value: item.main.temp, unitCode: 'C' } : undefined,\n          // Store rain/snow separately for better snow estimation\n          rain: rainMm > 0 ? { value: rainMm, unitCode: 'mm' } : undefined,\n          snow: snowMm > 0 ? { value: snowMm, unitCode: 'mm' } : undefined\n        }\n      };\n\n      observations.push(observation);\n    }\n\n    // If we have forecast data, also get current conditions for more recent data\n    try {\n      const currentUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${stationLat}&lon=${stationLon}&appid=${apiKey}&units=metric`;\n      const currentResponse = await fetch(currentUrl);\n\n      if (currentResponse.ok) {\n        const currentData = await currentResponse.json();\n\n        // Add current observation if it's not already covered by forecast\n        const currentTime = new Date().getTime() / 1000;\n        const hasRecentData = observations.some(obs => {\n          const obsTime = new Date(obs.timestamp).getTime() / 1000;\n          return Math.abs(obsTime - currentTime) < 3600; // Within 1 hour\n        });\n\n        if (!hasRecentData) {\n          const currentObservation: NWSObservation = {\n            timestamp: new Date().toISOString(),\n            temperature: currentData.main?.temp || null,\n            windSpeed: currentData.wind?.speed ? currentData.wind.speed * 3.6 : null,\n            windDirection: currentData.wind?.deg || null,\n            textDescription: currentData.weather?.[0]?.description || 'Unknown',\n            icon: currentData.weather?.[0]?.icon || '',\n            raw: {\n              ...currentData,\n              precipitation: undefined, // Current weather doesn't have precipitation history\n              temperature: currentData.main?.temp ? { value: currentData.main.temp, unitCode: 'C' } : undefined\n            }\n          };\n          observations.unshift(currentObservation); // Add at beginning\n        }\n      }\n    } catch (currentError) {\n      console.warn(`Failed to fetch current weather for station ${stationId}:`, currentError);\n      // Continue with forecast data only\n    }\n\n    return observations;\n  } catch (error) {\n    console.warn(`Failed to fetch forecast data for station ${stationId}:`, error);\n    return [];\n  }\n}\n\n// Estimate snowfall and rainfall from precipitation data\nfunction estimateSnowfall(precipMm: number, tempC: number, rainMm?: number, snowMm?: number): { snowfallIn: number; rainfallIn: number } {\n  // If we have direct rain/snow data from OpenWeatherMap, use it directly\n  if (rainMm !== undefined && snowMm !== undefined) {\n    const totalPrecipMm = rainMm + snowMm;\n    if (totalPrecipMm <= 0) return { snowfallIn: 0, rainfallIn: 0 };\n\n    // Convert mm to inches\n    const snowfallIn = snowMm / 25.4;\n    const rainfallIn = rainMm / 25.4;\n    return { snowfallIn, rainfallIn };\n  }\n\n  // Fallback to temperature-based estimation if no direct rain/snow data\n  if (precipMm <= 0) return { snowfallIn: 0, rainfallIn: 0 };\n\n  const precipIn = precipMm / 25.4;\n  let snowFraction = 0;\n\n  if (tempC <= -10) snowFraction = 1.0;\n  else if (tempC <= -2) snowFraction = 0.95;\n  else if (tempC <= 0) snowFraction = 0.9;\n  else if (tempC <= 3) snowFraction = 0.6;\n  else snowFraction = 0.1;\n\n  let ratio = 10; // default liquid to snow ratio\n  if (tempC <= -10) ratio = 18;\n  else if (tempC <= -2) ratio = 14;\n  else if (tempC <= 0) ratio = 12;\n  else if (tempC <= 3) ratio = 10;\n  else ratio = 8;\n\n  const snowfallIn = precipIn * ratio * snowFraction;\n  const rainfallIn = precipIn * (1 - snowFraction);\n\n  return { snowfallIn, rainfallIn };\n}\n\n// Process observations into hourly snowfall estimates with station location\nfunction processHourlySnowfall(observations: NWSObservation[], stationLat: number, stationLon: number, stationId: string): HourlySnowfall[] {\n  const hourly: { [hour: string]: { rain: number; snow: number; temp: number; count: number } } = {};\n\n  for (const obs of observations) {\n    const timestamp = new Date(obs.timestamp);\n    const hourKey = `${timestamp.getFullYear()}-${timestamp.getMonth()}-${timestamp.getDate()}-${timestamp.getHours()}`;\n\n    // Get rain and snow data separately if available, otherwise fall back to total precipitation\n    const rainMm = obs.raw?.rain?.value || 0;\n    const snowMm = obs.raw?.snow?.value || 0;\n    const totalPrecip = obs.raw?.precipitation?.value || 0;\n\n    // If we don't have separate rain/snow data, assume all precipitation is rain (will be converted in estimateSnowfall)\n    const effectiveRain = (rainMm + snowMm) > 0 ? rainMm : totalPrecip;\n    const effectiveSnow = snowMm;\n\n    const temp = obs.raw?.temperature?.value || obs.temperature || 0;\n\n    if (!hourly[hourKey]) {\n      hourly[hourKey] = { rain: 0, snow: 0, temp: 0, count: 0 };\n    }\n\n    hourly[hourKey].rain += effectiveRain;\n    hourly[hourKey].snow += effectiveSnow;\n    hourly[hourKey].temp += temp;\n    hourly[hourKey].count += 1;\n  }\n\n  const result: HourlySnowfall[] = [];\n  for (const [key, data] of Object.entries(hourly)) {\n    const [year, month, day, hour] = key.split('-').map(Number);\n    const timestamp = new Date(year, month, day, hour).getTime();\n    const avgTemp = data.temp / data.count;\n    const { snowfallIn, rainfallIn } = estimateSnowfall(data.rain + data.snow, avgTemp, data.rain, data.snow);\n\n    result.push({\n      timestamp,\n      snowfallIn,\n      rainfallIn,\n      lat: stationLat,\n      lon: stationLon,\n      stationId\n    });\n  }\n\n  return result.sort((a, b) => a.timestamp - b.timestamp);\n}\n\n// Fetch historical data for a single station\nasync function fetchStationHistorical(station: {id: string, lat: number, lon: number}): Promise<StationData> {\n  try {\n    const observations = await fetchHistoricalObservations(station.id, station.lat, station.lon);\n    const hourlyData = processHourlySnowfall(observations, station.lat, station.lon, station.id);\n\n    return {\n      stationId: station.id,\n      lat: station.lat,\n      lon: station.lon,\n      hourlyData\n    };\n  } catch (error) {\n    console.warn(`Failed to fetch data for station ${station.id}:`, error);\n    return {\n      stationId: station.id,\n      lat: station.lat,\n      lon: station.lon,\n      hourlyData: []\n    };\n  }\n}\n\n// Get comprehensive historical data for a resort area (using OpenWeatherMap directly at resort locations)\nexport async function getResortAreaHistorical(resortId: string): Promise<ResortAreaData> {\n  const resort = resorts.find(r => r.id === resortId);\n  if (!resort) {\n    throw new Error(`Resort ${resortId} not found`);\n  }\n\n  // Use the resort location directly as a \"station\"\n  const stationData = await fetchStationHistorical({\n    id: `${resortId}-resort`,\n    lat: resort.lat,\n    lon: resort.lon\n  });\n\n  return {\n    resortId,\n    stations: stationData.hourlyData.length > 0 ? [stationData] : []\n  };\n}\n\n// Get accumulated snowfall at a specific location and time\nexport function getAccumulatedSnowfallAtLocation(\n  stationData: StationData[],\n  lat: number,\n  lon: number,\n  upToTimestamp: number\n): number {\n  // Find the closest station with data\n  let closestStation: StationData | null = null;\n  let minDistance = Infinity;\n\n  for (const station of stationData) {\n    const distance = haversineDistance(lat, lon, station.lat, station.lon);\n    if (distance < minDistance && station.hourlyData.length > 0) {\n      minDistance = distance;\n      closestStation = station;\n    }\n  }\n\n  if (!closestStation) return 0;\n\n  return closestStation.hourlyData\n    .filter(h => h.timestamp <= upToTimestamp)\n    .reduce((sum, h) => sum + h.snowfallIn, 0);\n}\n\n// Get accumulated rainfall at a specific location and time\nexport function getAccumulatedRainfallAtLocation(\n  stationData: StationData[],\n  lat: number,\n  lon: number,\n  upToTimestamp: number\n): number {\n  // Find the closest station with data\n  let closestStation: StationData | null = null;\n  let minDistance = Infinity;\n\n  for (const station of stationData) {\n    const distance = haversineDistance(lat, lon, station.lat, station.lon);\n    if (distance < minDistance && station.hourlyData.length > 0) {\n      minDistance = distance;\n      closestStation = station;\n    }\n  }\n\n  if (!closestStation) return 0;\n\n  return closestStation.hourlyData\n    .filter(h => h.timestamp <= upToTimestamp)\n    .reduce((sum, h) => sum + h.rainfallIn, 0);\n}\n\n// Get all resort area historical data plus additional weather stations across Northeast\nexport async function getAllResortAreaHistorical(): Promise<ResortAreaData[]> {\n  // Check if we have valid cached data\n  const now = Date.now();\n  if (cachedResortData && (now - cacheTimestamp) < CACHE_DURATION) {\n    console.log(`[Historical] Using cached resort data (${Math.round((now - cacheTimestamp) / 1000)}s old)`);\n    return cachedResortData;\n  }\n\n  console.log('[Historical] Fetching fresh resort area historical data...');\n  const resortPromises = resorts.map(resort => getResortAreaHistorical(resort.id));\n  const resortData = await Promise.all(resortPromises);\n  \n  // Add additional weather stations across the Northeast for better radar coverage\n  const northeastStations = await getNortheastWeatherStations();\n  resortData.push(...northeastStations);\n  \n  // Cache the results\n  cachedResortData = resortData;\n  cacheTimestamp = now;\n  \n  console.log(`[Historical] Cached ${resortData.length} resort areas with weather data`);\n  return resortData;\n}\n\n// Generate additional weather stations across the Northeast region\nasync function getNortheastWeatherStations(): Promise<ResortAreaData[]> {\n  // Define a grid of weather stations across the Northeast\n  // Coverage: roughly Maine to Pennsylvania, west to Ohio\n  // Reduced from 27 to 9 stations to avoid rate limiting\n  const stations = [\n    // Maine\n    { lat: 43.6615, lon: -70.2553, name: 'Portland, ME' },\n    \n    // New Hampshire\n    { lat: 43.2081, lon: -71.5376, name: 'Concord, NH' },\n    \n    // Vermont\n    { lat: 44.2601, lon: -72.5754, name: 'Montpelier, VT' },\n    \n    // Massachusetts\n    { lat: 42.3601, lon: -71.0589, name: 'Boston, MA' },\n    \n    // Connecticut\n    { lat: 41.7658, lon: -72.6734, name: 'Hartford, CT' },\n    \n    // New York\n    { lat: 40.7128, lon: -74.0060, name: 'New York, NY' },\n    { lat: 42.6526, lon: -73.7562, name: 'Albany, NY' },\n    \n    // Pennsylvania\n    { lat: 39.9526, lon: -75.1652, name: 'Philadelphia, PA' },\n    \n    // Additional grid point for coverage\n    { lat: 43.0, lon: -74.0, name: 'Adirondacks' },\n  ];\n  \n  const stationPromises = stations.map(async (station, index) => {\n    try {\n      // Add delay between API calls to avoid rate limiting (1 second between calls)\n      if (index > 0) {\n        await new Promise(resolve => setTimeout(resolve, 1000));\n      }\n      \n      const stationData = await fetchStationHistorical({\n        id: `northeast-${index}`,\n        lat: station.lat,\n        lon: station.lon\n      });\n      \n      return {\n        resortId: `northeast-${station.name.replace(/[^a-zA-Z0-9]/g, '')}`,\n        stations: stationData.hourlyData.length > 0 ? [stationData] : []\n      };\n    } catch (error) {\n      console.warn(`Failed to create station for ${station.name}:`, error);\n      return null;\n    }\n  });\n  \n  const stationData = await Promise.all(stationPromises);\n  return stationData.filter((data): data is ResortAreaData => data !== null);\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 964, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/work/ski-conditions-aggregator/ski-conditions-aggregator/app/api/radar/tile/route.ts"],"sourcesContent":["import { NextResponse, NextRequest } from 'next/server';\nimport { idwGrid, Point } from '../lib/interpolation';\nimport { getAllResortAreaHistorical, getAccumulatedSnowfallAtLocation, getAccumulatedRainfallAtLocation } from '../lib/historical';\nimport { resorts } from '../../../../lib/resorts';\nimport { PNG } from 'pngjs';\n\nexport const dynamic = 'force-dynamic';\n\n/**\n * Radar Tile Proxy - Returns radar tile images based on real weather data\n * \n * Data Source: IDW interpolation of actual historical weather station data from resorts and Northeast stations\n * Coverage: Northeast US precipitation patterns (snowfall and rainfall)\n * \n * Query Params:\n *   layer - Must be \"synthetic-{timestamp}\"\n *   z, x, y - Tile coordinates\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = request.nextUrl;\n    \n    const layer = searchParams.get('layer');\n    const z = searchParams.get('z');\n    const x = searchParams.get('x');\n    const y = searchParams.get('y');\n    \n    if (!z || !x || !y || !layer) {\n      return NextResponse.json(\n        { error: 'Missing parameters. Required: layer, z, x, y' },\n        { status: 400 }\n      );\n    }\n    \n    const zNum = parseInt(z);\n    const xNum = parseInt(x);\n    const yNum = parseInt(y);\n    \n    if (isNaN(zNum) || isNaN(xNum) || isNaN(yNum)) {\n      return NextResponse.json({ error: 'Invalid tile coordinates' }, { status: 400 });\n    }\n\n    if (zNum < 0 || zNum > 18) return getTransparentTile();\n    \n    const maxTile = Math.pow(2, zNum);\n    if (xNum < 0 || xNum >= maxTile || yNum < 0 || yNum >= maxTile) {\n      return getTransparentTile();\n    }\n\n    // Handle real weather data (based on resort observations and weather stations)\n    if (layer.startsWith('synthetic-')) {\n      // Layer is \"synthetic-{timestamp}\" but now uses real weather data\n      const timestamp = parseInt(layer.split('-')[1]);\n      if (isNaN(timestamp)) {\n        return NextResponse.json({ error: 'Invalid synthetic timestamp' }, { status: 400 });\n      }\n\n      console.log(`[Tile] Real weather data: z=${zNum} x=${xNum} y=${yNum} time=${timestamp}`);\n      \n      // Generate tile with real weather data from resort observations and weather stations\n      return await generatePurelySyntheticTile(zNum, xNum, yNum, timestamp);\n    }\n\n    // If we get here, it's an invalid layer format\n    return NextResponse.json({ error: 'Invalid layer format - only real weather data layers supported' }, { status: 400 });\n\n  } catch (error: any) {\n    console.error('[Tile] Error:', error.message);\n    return getTransparentTile();\n  }\n}\n\n// Generate real weather data points from resort observations and weather stations\nasync function generateRealWeatherDataPoints(\n  timestamp: number\n): Promise<Point[]> {\n  try {\n    // Fetch all resort area historical data including additional weather stations\n    const resortAreaData = await getAllResortAreaHistorical();\n    const realPoints: Point[] = [];\n\n    // Create Point objects at station locations with accumulated precipitation\n    for (const resortArea of resortAreaData) {\n      for (const station of resortArea.stations) {\n        // Get accumulated snowfall and rainfall up to the given timestamp\n        const snowfall = getAccumulatedSnowfallAtLocation(\n          resortArea.stations,\n          station.lat,\n          station.lon,\n          timestamp\n        );\n        const rainfall = getAccumulatedRainfallAtLocation(\n          resortArea.stations,\n          station.lat,\n          station.lon,\n          timestamp\n        );\n\n        // Combine snowfall and rainfall for total precipitation value\n        // Weight snowfall more heavily as it's more visible on radar\n        const totalPrecipitation = snowfall + (rainfall * 0.1);\n\n        // Only add points with meaningful precipitation\n        if (totalPrecipitation > 0) {\n          realPoints.push({\n            lat: station.lat,\n            lon: station.lon,\n            value: totalPrecipitation\n          });\n        }\n      }\n    }\n\n    console.log(`[Tile] Generated ${realPoints.length} real weather data points for timestamp ${new Date(timestamp).toISOString()}`);\n    return realPoints;\n  } catch (error: any) {\n    console.error('[Tile] Error generating real weather data points:', error.message);\n    return [];\n  }\n}\n\n// Convert tile coordinates to lat/lon bounds (EPSG:4326)\nfunction getTileBoundsLatLon(z: number, x: number, y: number): string {\n  // Correct Web Mercator to lat/lon conversion\n  const n = Math.pow(2, z);\n  const lon0 = (x / n) * 360 - 180;\n  const lon1 = ((x + 1) / n) * 360 - 180;\n\n  // Correct latitude calculation\n  const lat0 = (2 * Math.atan(Math.exp(Math.PI * (1 - 2 * y / n))) - Math.PI / 2) * 180 / Math.PI;\n  const lat1 = (2 * Math.atan(Math.exp(Math.PI * (1 - 2 * (y + 1) / n))) - Math.PI / 2) * 180 / Math.PI;\n\n  // WMS 1.3.0 BBOX format for EPSG:4326: minY,minX,maxY,maxX\n  // Y is latitude (minY = southern lat, maxY = northern lat)\n  // X is longitude (minX = western lon, maxX = eastern lon)\n  const minLat = Math.min(lat0, lat1);\n  const maxLat = Math.max(lat0, lat1);\n  const minLon = Math.min(lon0, lon1);\n  const maxLon = Math.max(lon0, lon1);\n  return `${minLat},${minLon},${maxLat},${maxLon}`;\n}\n\nfunction getTransparentTile(): Response {\n  // 1x1 transparent PNG\n  const transparentPng = Buffer.from([\n    0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a,\n    0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,\n    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,\n    0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4,\n    0x89, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41,\n    0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,\n    0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00,\n    0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae,\n    0x42, 0x60, 0x82,\n  ]);\n  \n  return new NextResponse(transparentPng, {\n    headers: {\n      'Content-Type': 'image/png',\n      'Cache-Control': 'public, max-age=300',\n      'Access-Control-Allow-Origin': '*'\n    }\n  });\n}\n\nasync function generatePurelySyntheticTile(z: number, x: number, y: number, timestamp: number): Promise<Response> {\n  try {\n    // Get tile bounds\n    const n = Math.pow(2, z);\n    const lon0 = (x / n) * 360 - 180;\n    const lat0 = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n))) * 180 / Math.PI;\n    const lon1 = ((x + 1) / n) * 360 - 180;\n    const lat1 = Math.atan(Math.sinh(Math.PI * (1 - 2 * (y + 1) / n))) * 180 / Math.PI;\n\n    // Generate real weather data points from resort observations and weather stations\n    const realPoints = await generateRealWeatherDataPoints(timestamp);\n\n    console.log(`[Tile] Real weather data z=${z} x=${x} y=${y} t=${new Date(timestamp).toISOString().slice(0,16)}: ${realPoints.length} data points`);\n\n    // If no real data is available, return transparent tile\n    if (realPoints.length === 0) {\n      console.log('[Tile] No real weather data available, returning transparent tile');\n      return getTransparentTile();\n    }\n\n    // Use optimized interpolation parameters for realistic weather radar appearance\n    const grid = idwGrid(realPoints, 256, 256, lat0, lon0, lat1, lon1, {\n      power: 2,    // Moderate power for natural falloff\n      radius: 150  // Larger radius for smoother blending between weather systems\n    });\n\n    // Create PNG with Doppler-style radar coloring\n    const pngBuffer = createDopplerRadarPNG(grid.data);\n\n    return new NextResponse(new Uint8Array(pngBuffer), {\n      headers: {\n        'Content-Type': 'image/png',\n        'Cache-Control': 'public, max-age=300',\n        'Access-Control-Allow-Origin': '*'\n      }\n    });\n  } catch (error: any) {\n    console.error('[Tile] Error generating tile with real weather data:', error.message);\n    return getTransparentTile();\n  }\n}\n\nfunction createDopplerRadarPNG(data: number[][]): Buffer {\n  const width = data[0].length;\n  const height = data.length;\n  const png = new PNG({ width, height });\n\n  // Apply simple smoothing to reduce extreme local variations\n  const smoothedData = smoothGrid(data, 2); // 2-pixel smoothing radius for smoother radar appearance\n\n  // Find max value for scaling (cap at reasonable snowfall amounts)\n  let maxVal = 0;\n  for (const row of smoothedData) {\n    for (const val of row) {\n      if (val > maxVal) maxVal = val;\n    }\n  }\n\n  // Doppler radar color scale (similar to weather.com/Apple Maps)\n  // Based on reflectivity levels, but adapted for snowfall intensity\n  function getDopplerColor(intensity: number): [number, number, number, number] {\n    // Scale 0-1 where 1 is maximum snowfall\n    const normalized = Math.min(intensity, 1);\n\n    if (normalized < 0.1) return [0, 0, 0, 0]; // Transparent for very light/no snow\n    if (normalized < 0.2) return [173, 216, 230, 180]; // Light blue\n    if (normalized < 0.3) return [135, 206, 235, 200]; // Sky blue\n    if (normalized < 0.4) return [70, 130, 180, 220]; // Steel blue\n    if (normalized < 0.5) return [25, 25, 112, 240]; // Midnight blue\n    if (normalized < 0.6) return [0, 100, 0, 255]; // Dark green\n    if (normalized < 0.7) return [34, 139, 34, 255]; // Forest green\n    if (normalized < 0.8) return [255, 215, 0, 255]; // Gold\n    if (normalized < 0.9) return [255, 140, 0, 255]; // Dark orange\n    if (normalized < 0.98) return [220, 20, 60, 255]; // Crimson (less bright red)\n    return [139, 0, 0, 255]; // Dark red for absolute maximum\n  }\n\n  for (let y = 0; y < height; y++) {\n    for (let x = 0; x < width; x++) {\n      const val = smoothedData[y][x];\n      const intensity = maxVal > 0 ? Math.min(val / Math.max(maxVal, 0.1), 1.0) : 0; // Clamp to [0,1]\n      const [r, g, b, a] = getDopplerColor(intensity);\n\n      const idx = (width * y + x) << 2;\n      png.data[idx] = r;     // R\n      png.data[idx + 1] = g; // G\n      png.data[idx + 2] = b; // B\n      png.data[idx + 3] = a; // A\n    }\n  }\n\n  return PNG.sync.write(png);\n}\n\n// Simple box filter smoothing to reduce extreme local variations\nfunction smoothGrid(data: number[][], radius: number): number[][] {\n  const height = data.length;\n  const width = data[0].length;\n  const smoothed: number[][] = [];\n\n  for (let y = 0; y < height; y++) {\n    const row: number[] = [];\n    for (let x = 0; x < width; x++) {\n      let sum = 0;\n      let count = 0;\n\n      // Average over a box around this pixel\n      for (let dy = -radius; dy <= radius; dy++) {\n        for (let dx = -radius; dx <= radius; dx++) {\n          const ny = y + dy;\n          const nx = x + dx;\n          if (ny >= 0 && ny < height && nx >= 0 && nx < width && !isNaN(data[ny][nx])) {\n            sum += data[ny][nx];\n            count++;\n          }\n        }\n      }\n\n      row.push(count > 0 ? sum / count : 0);\n    }\n    smoothed.push(row);\n  }\n\n  return smoothed;\n}\n"],"names":[],"mappings":"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"}}]
}